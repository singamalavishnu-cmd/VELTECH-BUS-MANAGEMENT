<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vel Tech Bus Management</title>
    <link rel="stylesheet" href="css/output.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>

</head>

<body class="bg-gray-100 min-h-screen flex flex-col relative z-0" data-mode="admin">
    <script>
        (function () {
            // Check Session
            if (sessionStorage.getItem('admin_authenticated') !== 'true') {
                window.location.replace('admin-login.html');
            }
            // BFCache Guard
            window.addEventListener('pageshow', function (event) {
                if (event.persisted) {
                    window.location.reload();
                }
            });
        })();
    </script>
    <!-- Main Application Container -->
    <div class="flex-grow flex flex-col p-4 md:p-8">

        <!-- Header -->
    </div>

    <!-- Admin Authentication Modal -->
    <div id="admin-auth-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <img src="images/vt.jpg" alt="Vel Tech Logo" class="h-10 w-auto rounded-lg shadow-sm mr-3">
                <h3 class="text-xl font-bold text-gray-800">Admin Authentication</h3>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="admin-email" class="block text-sm font-medium text-gray-700">Admin Email</label>
                    <input type="email" id="admin-email"
                        class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="admin@veltech.edu">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-password"
                        class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter admin password">
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" id="auth-cancel-btn"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500">Cancel</button>
                    <button type="button" id="auth-login-btn"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">Authenticate</button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-white rounded-xl shadow-md p-4 md:p-6 mb-6 relative z-10">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img id="logo" src="images/vt.jpg" alt="Vel Tech Logo" class="h-12 w-auto cursor-pointer">
                <h1 id="site-title" class="text-2xl md:text-3xl font-bold text-gray-800 cursor-pointer">Vel Tech Bus
                    Management</h1>
            </div>
            <!-- Navigation Tabs -->
            <nav class="flex space-x-2 md:space-x-4" role="tablist">
                <button id="schedule-tab" role="tab" aria-controls="schedule-section" aria-selected="false"
                    class="px-3 py-2 md:px-4 md:py-2 font-medium text-gray-600 rounded-lg hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200">Bus
                    Schedule</button>
                <button id="manage-tab" role="tab" aria-controls="manage-section" aria-selected="false"
                    class="px-3 py-2 md:px-4 md:py-2 font-medium text-gray-600 rounded-lg hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200">Manage
                    Routes</button>
                <button id="logins-tab" role="tab" aria-controls="logins-section" aria-selected="false"
                    class="px-3 py-2 md:px-4 md:py-2 font-medium text-gray-600 rounded-lg hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200">Students
                    &amp; Alerts</button>
            </nav>
            <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                <select id="unfreeze-route-select" style="min-width: 180px; max-width: 250px;"
                    class="px-4 py-2 font-medium text-gray-900 bg-orange-500 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 transition-colors duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                    <option value="">üîì Unfreeze Route</option>
                </select>
                <button id="change-password-btn"
                    class="px-4 py-2 font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200">Change
                    Password</button>
                <button id="logout-btn"
                    class="px-4 py-2 font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:bg-red-700 transition-colors duration-200">Logout</button>
            </div>
        </div>
    </header>

    <!-- Dynamic Content Sections -->
    <main class="flex-grow relative z-10">
        <!-- Dashboard Section -->
        <section id="dashboard-section" class="content-section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dashboard Cards -->
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Active Buses</p>
                        <h2 class="text-3xl font-semibold text-gray-800" id="active-buses-count">0</h2>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.553-.894L11 8m0 0l-5 2.5a1 1 0 010 1.789l5 2.5m0 0l7.585-3.793a1 1 0 01.915-.028L19 12m-8 2l8 4" />
                    </svg>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">On-Time Departures</p>
                        <h2 class="text-3xl font-semibold text-gray-800" id="on-time-count">0</h2>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Scheduled Trips Today</p>
                        <h2 class="text-3xl font-semibold text-gray-800" id="trips-today-count">0</h2>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="h-10 w-10 text-purple-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-4.509 0-8.25 3.692-8.25 8.25 0 4.51 3.692 8.25 8.25 8.25 4.508 0 8.25-3.692 8.25-8.25 0-2.208-.953-4.214-2.5-5.673m-13.488 5.856a48.111 48.111 0 0 1-3.473-1.042" />
                    </svg>
                </div>
            </div>

            <!-- Live Map Section -->
            <div class="mt-8 flex justify-end">
                <div class="bg-white p-6 rounded-xl shadow-md w-full md:w-4/12 lg:w-3/12">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">College Location</h2>
                    <div id="map-placeholder" class="bg-gray-200 rounded-lg overflow-hidden cursor-pointer"
                        style="height:14rem; min-height:14rem;">
                        <div id="college-map" class="w-full h-full"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Notes Section -->
            <div class="grid grid-cols-1 gap-6 mt-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Special Notes from Admin</h3>
                        <button id="edit-notes-btn"
                            class="px-3 py-1 text-xs font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">Edit</button>
                    </div>
                    <p id="admin-notes-display" class="text-gray-600">
                        Loading notes...
                    </p>
                    <textarea id="admin-notes-textarea"
                        class="hidden w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <div class="flex space-x-2 mt-2">
                        <button id="cancel-notes-btn"
                            class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">Cancel</button>
                        <button id="save-notes-btn"
                            class="hidden px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">Save</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bus Schedule Section -->
        <section id="schedule-section" class="content-section hidden">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Bus Schedule</h2>
                    <div id="weekly-dates-container" class="flex flex-wrap gap-2 mt-2 md:mt-0">
                        <!-- Weekly dates will be populated here -->
                    </div>
                    <!-- Hidden date input for JS compatibility -->
                    <input type="date" id="schedule-date" class="hidden">
                    <p id="current-time" class="text-lg font-bold text-gray-700 ml-4"></p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto border-collapse">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left rounded-tl-lg">Bus No.</th>
                                <th class="py-3 px-6 text-left">Route</th>
                                <th class="py-3 px-6 text-left">Departure Time</th>
                                <th class="py-3 px-6 text-left rounded-tr-lg">ETA</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-table-body" class="text-gray-600 text-sm font-medium">
                            <tr>
                                <td colspan="4" class="py-3 px-6 text-center text-gray-400">Loading schedule...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Manage Routes Section -->
        <section id="manage-section" class="content-section hidden">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Manage Routes</h2>

                <!-- Route Creation Form -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Add New Route</h3>
                    <form id="add-bus-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="bus-number" class="block text-sm font-medium text-gray-700">Bus
                                    Number</label>
                                <input type="text" id="bus-number" name="busNumber" required
                                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="route-name" class="block text-sm font-medium text-gray-700">Route
                                    Name</label>
                                <input type="text" id="route-name" name="routeName" required
                                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- AI Route Optimization Section -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-semibold text-blue-800">ü§ñ AI Route Optimizer</h3>
                                <button type="button" id="ai-optimize-btn"
                                    class="px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Optimize
                                    Route</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Start Point</label>
                                    <input type="text" id="start-point" value="Vel Tech University, Chennai"
                                        placeholder="e.g., Chennai Central"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">End Point</label>
                                    <input type="text" id="end-point" placeholder="e.g., University"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                            </div>


                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="departure-time" class="block text-sm font-medium text-gray-700">Departure
                                    Time (From College - All Days)</label>
                                <div class="mt-1 flex items-center space-x-2">
                                    <input type="time" id="departure-time" name="departureTime" required
                                        class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <select id="departure-ampm"
                                        class="px-2 py-2 border border-gray-300 rounded-md bg-white text-sm">
                                        <option value="AM" selected>AM</option>
                                        <option value="PM">PM</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="eta" class="block text-sm font-medium text-gray-700">Estimated Arrival Time
                                    (At Last Stop)</label>
                                <div class="mt-1 flex items-center space-x-2">
                                    <input type="time" id="eta" name="eta" required
                                        class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <select id="eta-ampm"
                                        class="px-2 py-2 border border-gray-300 rounded-md bg-white text-sm">
                                        <option value="AM" selected>AM</option>
                                        <option value="PM">PM</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">
                                Stops with ETA
                            </label>
                            <div id="stops-builder" class="mt-2 space-y-2">
                                <!-- Dynamic stop rows will be inserted here -->
                            </div>
                            <button type="button" id="add-stop-btn"
                                class="mt-2 px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">+
                                Add Stop</button>
                            <p class="text-xs text-gray-500 mt-2">Stops are auto-synced to the database. Format preview
                                stored internally.</p>
                            <textarea id="stops-data" name="stopsData" rows="3" required
                                class="hidden mt-1 w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                        </div>
                        <button type="submit" id="submit-btn"
                            class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">Add
                            Bus</button>
                    </form>
                </div>

                <!-- Driver Assignment Form -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Assign Driver to Route</h3>
                    <form id="assign-driver-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="driver-name" class="block text-sm font-medium text-gray-700">Driver
                                    Name</label>
                                <input type="text" id="driver-name" name="driverName" required
                                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="driver-bus-number" class="block text-sm font-medium text-gray-700">Select
                                    Bus Number</label>
                                <select id="driver-bus-number" name="driverBusNumber" required
                                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Select Bus Number</option>
                                    <!-- Bus options will be populated from routes -->
                                </select>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2"><strong>Route Information:</strong> (Auto-populated
                                from selected bus)</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Assigned Route</label>
                                    <input type="text" id="driver-route-name" name="driverRouteName" readonly
                                        class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm"
                                        placeholder="Route name will auto-populate">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Departure Time</label>
                                    <input type="text" id="driver-departure-time" name="driverDepartureTime" readonly
                                        class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm"
                                        placeholder="Departure time will auto-populate">
                                </div>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">Assign
                            Driver</button>
                    </form>
                </div>

                <!-- Unified Routes and Driver Status Table -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Current Routes & Driver Status</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto border-collapse">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Bus No.</th>
                                    <th class="py-3 px-6 text-left">Route Name</th>
                                    <th class="py-3 px-6 text-left">Driver Name</th>
                                    <th class="py-3 px-6 text-left">Departure Time</th>
                                    <th class="py-3 px-6 text-left">Arrival Time</th>
                                    <th class="py-3 px-6 text-left">Trips Today</th>
                                    <th class="py-3 px-6 text-left">Current Status</th>
                                    <th class="py-3 px-6 text-left rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="unified-routes-tbody" class="text-gray-600 text-sm font-medium">
                                <tr>
                                    <td colspan="8" class="py-3 px-6 text-center text-gray-400">Loading routes and
                                        driver status...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Students & Alerts Section -->
        <section id="logins-section" class="content-section hidden">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <span>Students &amp; Alerts</span>
                        <span id="emergency-alert-header-badge"
                            class="hidden px-2 py-0.5 text-xs font-semibold text-white bg-red-600 rounded-full">New</span>
                    </h2>
                </div>
                <div class="flex flex-wrap gap-2 mb-6" role="tablist">
                    <button id="students-subtab-logins" role="tab" aria-selected="true"
                        class="px-3 py-2 text-sm font-medium rounded-md bg-blue-600 text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Student
                        Logins</button>
                    <button id="students-subtab-emergencies" role="tab" aria-selected="false"
                        class="px-3 py-2 text-sm font-medium rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">Emergency
                        Alerts</button>
                    <button id="students-subtab-notifications" role="tab" aria-selected="false"
                        class="px-3 py-2 text-sm font-medium rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">Send
                        Notifications</button>
                </div>
                <div id="student-logins-panel" role="tabpanel">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Student Login Activity</h3>
                        <div class="flex flex-row space-x-2">
                            <button id="refresh-logs"
                                class="px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Refresh</button>
                            <button id="clear-logs"
                                class="px-3 py-2 text-sm font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700">Clear
                                Logs</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto border-collapse">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">#</th>
                                    <th class="py-3 px-6 text-left">Email</th>
                                    <th class="py-3 px-6 text-left">Student ID</th>
                                    <th class="py-3 px-6 text-left rounded-tr-lg">Login Time</th>
                                </tr>
                            </thead>
                            <tbody id="login-logs-tbody" class="text-gray-600 text-sm font-medium">
                                <tr>
                                    <td colspan="4" class="py-3 px-6 text-center text-gray-400">Loading login logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="emergency-alerts-panel" role="tabpanel" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Emergency Alerts</h3>
                    </div>
                    <div id="emergency-alerts-list" class="space-y-3 max-h-96 overflow-y-auto text-sm text-gray-600">
                        <p class="text-gray-500">No emergency alerts yet.</p>
                    </div>
                </div>

                <div id="notifications-panel" role="tabpanel" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Send Custom Notifications</h3>
                    </div>
                    <form id="notification-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="notification-recipient" class="block text-sm font-medium text-gray-700">Send
                                    To</label>
                                <select id="notification-recipient"
                                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="all">All Users</option>
                                    <option value="students">Students Only</option>
                                    <option value="drivers">Drivers Only</option>
                                    <option value="admins">Admins Only</option>
                                </select>
                            </div>
                            <div>
                                <label for="notification-bus" class="block text-sm font-medium text-gray-700">Specific
                                    Bus (Optional)</label>
                                <input type="text" id="notification-bus" placeholder="e.g., VT-01"
                                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="notification-title" class="block text-sm font-medium text-gray-700">Notification
                                Title</label>
                            <input type="text" id="notification-title" required placeholder="e.g., Bus Delay Alert"
                                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="notification-message"
                                class="block text-sm font-medium text-gray-700">Message</label>
                            <textarea id="notification-message" required rows="3"
                                placeholder="Enter your notification message here..."
                                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                        </div>
                        <div>
                            <label for="notification-type" class="block text-sm font-medium text-gray-700">Notification
                                Type</label>
                            <select id="notification-type"
                                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="info">Information</option>
                                <option value="warning">Warning</option>
                                <option value="emergency">Emergency</option>
                                <option value="success">Success</option>
                            </select>
                        </div>
                        <button type="submit"
                            class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">Send
                            Notification</button>
                    </form>

                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Recent Notifications</h3>
                            <button id="clear-notifications-btn"
                                class="text-xs text-red-600 hover:text-red-800 hover:underline">Clear History</button>
                        </div>
                        <div id="recent-notifications-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            <!-- Notifications loaded dynamically -->
                            <p class="text-gray-500 text-center py-4">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Spinner -->
    <div id="loading-spinner"
        class="fixed inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 z-[99] hidden">
        <div class="animate-bus-animation w-16 h-8 bus-icon-placeholder"></div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="message-box hidden bg-white p-6 rounded-xl shadow-lg border border-gray-300">
        <p id="message-text" class="text-center font-medium text-gray-800"></p>
        <div class="flex justify-center mt-4">
            <button id="message-ok"
                class="px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">OK</button>
        </div>
    </div>

    <!-- Stops Modal -->
    <div id="stops-modal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="stops-modal-title" class="text-xl font-bold">Bus Stops</h2>
                <button id="close-stops-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <!-- Bus stops table will be populated here -->
            <table class="w-full table-auto border-collapse">
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left rounded-tl-lg">Stop</th>
                        <th class="py-3 px-6 text-left rounded-tr-lg">ETA</th>
                    </tr>
                </thead>
                <tbody id="stops-table-body" class="text-gray-600 text-sm font-medium">
                    <!-- Stops will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Change Admin Password</h2>
                <button id="close-change-password-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Current Password</label>
                    <input id="cp-current" type="password"
                        class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500"
                        placeholder="Enter current password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">New Password</label>
                    <input id="cp-new" type="password"
                        class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500"
                        placeholder="Enter new password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                    <input id="cp-confirm" type="password"
                        class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500"
                        placeholder="Re-enter new password">
                </div>
                <p id="cp-error" class="text-sm text-red-600 hidden"></p>
                <p id="cp-success" class="text-sm text-green-600 hidden"></p>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cp-cancel" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
                    <button type="submit" id="cp-submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center p-4 mt-8 rounded-xl shadow-md">
        <p>&copy; 2024 Vel Tech Bus Management. All Rights Reserved.</p>
    </footer>
    </div>

    <!-- JavaScript for dynamic functionality -->
    <script>
        // --- Admin Authentication Modal Management ---
        const adminAuthModal = document.getElementById('admin-auth-modal');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const authLoginBtn = document.getElementById('auth-login-btn');
        const authCancelBtn = document.getElementById('auth-cancel-btn');

        // Show authentication modal when RPC functions need admin access
        function showAdminAuthModal() {
            if (adminAuthModal) {
                adminAuthModal.classList.remove('hidden');
                adminEmailInput.value = '';
                adminPasswordInput.value = '';
                adminEmailInput.focus();
            }
        }

        // Handle admin authentication
        authLoginBtn?.addEventListener('click', async () => {
            const email = adminEmailInput?.value?.trim();
            const password = adminPasswordInput?.value;

            if (!email || !password) {
                showMessage('Please enter both email and password');
                return;
            }

            try {
                showLoading();
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({ email, password });

                if (error) {
                    hideLoading();
                    showMessage(`Authentication failed: ${error.message}`);
                } else {
                    // Store admin session
                    sessionStorage.setItem('admin_authenticated', 'true');
                    sessionStorage.setItem('admin_email', email);

                    hideLoading();
                    showMessage('‚úÖ Admin authentication successful!');
                    hideAdminAuthModal();

                    // Reload page to apply authentication
                    setTimeout(() => location.reload(), 1000);
                }
            } catch (e) {
                hideLoading();
                showMessage(`Authentication error: ${e.message}`);
            }
        });

        // Handle cancel
        authCancelBtn?.addEventListener('click', () => {
            hideAdminAuthModal();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !adminAuthModal?.classList.contains('hidden')) {
                hideAdminAuthModal();
            }
        });

        function hideAdminAuthModal() {
            if (adminAuthModal) {
                adminAuthModal.classList.add('hidden');
            }
        }

        // --- Admin Authentication Guard ---
        (async function () {
            try {
                const isAuthenticated = sessionStorage.getItem('admin_authenticated') === 'true';
                if (!isAuthenticated) {
                    window.location.href = 'admin-login.html';
                    return;
                }
                console.log('Admin authenticated via sessionStorage');
            } catch (e) {
                console.error('Auth guard error:', e);
                window.location.href = 'admin-login.html';
            }
        })();
        // --- Data Mockup (expanded) ---
        // These are fallback mock data in case the DB connection fails, but the code relies on loadRoutes()
        const busScheduleData = [];

        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let adminNotes = "Loading notes...";
        let addedRoutesData = [];

        // --- Persistence Keys ---
        const STORAGE_KEYS = {
            notes: 'vt_admin_notes',
            routes: 'vt_added_routes'
        };

        // --- DOM Elements ---
        const modeToggleBtn = document.getElementById('mode-toggle-btn');
        const dashboardTab = document.getElementById('dashboard-tab');
        const scheduleTab = document.getElementById('schedule-tab');
        const manageTab = document.getElementById('manage-tab');
        const loginsTab = document.getElementById('logins-tab');
        const logoutBtn = document.getElementById('logout-btn');
        const logo = document.getElementById('logo');
        const siteTitle = document.getElementById('site-title');

        const dashboardSection = document.getElementById('dashboard-section');
        const scheduleSection = document.getElementById('schedule-section');
        const manageSection = document.getElementById('manage-section');
        const loginsSection = document.getElementById('logins-section');

        const scheduleTableBody = document.getElementById('schedule-table-body');
        const addBusForm = document.getElementById('add-bus-form');
        const scheduleDateInput = document.getElementById('schedule-date');
        const currentTimeEl = document.getElementById('current-time');
        const activeBusesCountEl = document.getElementById('active-buses-count');
        const onTimeCountEl = document.getElementById('on-time-count');
        const tripsTodayCountEl = document.getElementById('trips-today-count');
        const userRoutesTableBody = document.getElementById('user-routes-table-body');
        const weeklyDatesContainer = document.getElementById('weekly-dates-container');
        const loginLogsTbody = document.getElementById('login-logs-tbody');
        const refreshLogsBtn = document.getElementById('refresh-logs');
        const clearLogsBtn = document.getElementById('clear-logs');

        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok');

        const stopsModal = document.getElementById('stops-modal');
        const stopsModalTitle = document.getElementById('stops-modal-title');
        const stopsTableBody = document.getElementById('stops-table-body');
        const closeStopsModal = document.getElementById('close-stops-modal');
        const submitBtn = document.getElementById('submit-btn');

        // Change Password Elements
        const changePasswordBtn = document.getElementById('change-password-btn');
        const changePasswordModal = document.getElementById('change-password-modal');
        const closeChangePasswordModalBtn = document.getElementById('close-change-password-modal');
        const changePasswordForm = document.getElementById('change-password-form');
        const cpCurrent = document.getElementById('cp-current');
        const cpNew = document.getElementById('cp-new');
        const cpConfirm = document.getElementById('cp-confirm');
        const cpError = document.getElementById('cp-error');
        const cpSuccess = document.getElementById('cp-success');
        const cpCancel = document.getElementById('cp-cancel');

        // Immediately hide modal on page load
        if (stopsModal) {
            stopsModal.classList.add('hidden');
        }

        const busNumberInput = document.getElementById('bus-number');
        const routeNameInput = document.getElementById('route-name');
        const departureTimeInput = document.getElementById('departure-time');
        const etaInput = document.getElementById('eta');
        const departureAmPm = document.getElementById('departure-ampm');
        const etaAmPm = document.getElementById('eta-ampm');

        const stopsDataTextarea = document.getElementById('stops-data');
        const stopsBuilder = document.getElementById('stops-builder');
        const addStopBtn = document.getElementById('add-stop-btn');
        const loadingSpinner = document.getElementById('loading-spinner');

        const adminNotesDisplay = document.getElementById('admin-notes-display');
        const adminNotesTextarea = document.getElementById('admin-notes-textarea');
        const editNotesBtn = document.getElementById('edit-notes-btn');
        const saveNotesBtn = document.getElementById('save-notes-btn');
        const emergencyAlertCount = document.getElementById('emergency-alert-count');
        const emergencyAlertBadge = document.getElementById('emergency-alert-badge');
        const emergencyAlertsList = document.getElementById('emergency-alerts-list');
        const studentLoginsPanel = document.getElementById('student-logins-panel');
        const emergencyAlertsPanel = document.getElementById('emergency-alerts-panel');
        const notificationsPanel = document.getElementById('notifications-panel');
        const studentsSubtabLogins = document.getElementById('students-subtab-logins');
        const studentsSubtabEmergencies = document.getElementById('students-subtab-emergencies');
        const studentsSubtabNotifications = document.getElementById('students-subtab-notifications');
        const emergencyAlertHeaderBadge = document.getElementById('emergency-alert-header-badge');

        let isEditing = false;
        let editingIndex = -1;
        let suppressTopLevelSync = false;
        let isNotesEditing = false;
        let emergencyAlerts = [];
        let emergencyLastSeen = null;

        // --- Persistence Keys ---
        const ADMIN_STORAGE = {
            studentLoginLogs: 'vt_student_login_logs',
            adminAuth: 'vt_admin_authed'
        };
        const ADMIN_ALLOWED_UID = '8bd75827-1bcb-45eb-8aa2-1ff722ee6ddc';
        const EMERGENCY_LAST_SEEN_KEY = 'vt_admin_emergency_last_seen';

        // --- Functions ---

        /**
         * Shows the loading spinner.
         */
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        /**
         * Hides all content sections.
         */
        function hideAllSections() {
            dashboardSection.classList.add('hidden');
            scheduleSection.classList.add('hidden');
            manageSection.classList.add('hidden');
            loginsSection.classList.add('hidden');
        }

        // --- AI Route Optimization Function ---
        // Initialize route map for visualization


        // Geocode location name to coordinates using Nominatim API (Free tier, no API key required)
        async function geocodeLocation(locationName) {
            try {
                console.log('üîç Geocoding location:', locationName);

                // Handle empty or invalid input
                if (!locationName || locationName.trim() === '') {
                    console.error('‚ùå Empty location name provided');
                    return null;
                }

                const searchName = locationName.toLowerCase().trim();

                // Known coordinates for common Chennai locations
                const knownLocations = {
                    'vel tech university': { lat: 13.0694, lng: 80.0756 },
                    'veltech': { lat: 13.0694, lng: 80.0756 },
                    'avadi': { lat: 13.1147, lng: 80.0968 },
                    'ambattur': { lat: 13.0980, lng: 80.1617 },
                    'padi': { lat: 13.0965, lng: 80.1846 },
                    'anna nagar': { lat: 13.0850, lng: 80.2081 },
                    'anna nagar east': { lat: 13.0850, lng: 80.2081 },
                    'anna nagar west': { lat: 13.0850, lng: 80.2081 },
                    'koyambedu': { lat: 13.0694, lng: 80.1945 },
                    'cmbt': { lat: 13.0694, lng: 80.1945 },
                    'chennai central': { lat: 13.0827, lng: 80.2707 },
                    'central': { lat: 13.0827, lng: 80.2707 },
                    'tambaram': { lat: 12.9249, lng: 80.1270 },
                    'velachery': { lat: 12.9815, lng: 80.2180 },
                    'adyar': { lat: 13.0012, lng: 80.2565 },
                    't nagar': { lat: 13.0338, lng: 80.2346 },
                    't. nagar': { lat: 13.0338, lng: 80.2346 },
                    'tnagar': { lat: 13.0338, lng: 80.2346 },
                    'porur': { lat: 13.0382, lng: 80.1565 },
                    'guindy': { lat: 13.0067, lng: 80.2206 },
                    ' Saidapet': { lat: 13.0153, lng: 80.2235 },
                    'mylapore': { lat: 13.0338, lng: 80.2670 },
                    'nungambakkam': { lat: 13.0605, lng: 80.2423 },
                    'kilpauk': { lat: 13.0796, lng: 80.2447 },
                    'perambur': { lat: 13.1082, lng: 80.2537 },
                    'washermanpet': { lat: 13.1143, lng: 80.2853 },
                    'Royapuram': { lat: 13.1058, lng: 80.2929 },
                    'thiruvanmiyur': { lat: 12.9830, lng: 80.2594 },
                    'besant nagar': { lat: 13.0003, lng: 80.2668 },
                    'chromepet': { lat: 12.9516, lng: 80.1462 },
                    'pallavaram': { lat: 12.9675, lng: 80.1491 },
                    'meenambakkam': { lat: 12.9845, lng: 80.1710 },
                    'alwarpet': { lat: 13.0352, lng: 80.2510 },
                    'mambalam': { lat: 13.0342, lng: 80.2219 },
                    'west mambalam': { lat: 13.0342, lng: 80.2219 },
                    'east tambaram': { lat: 12.9249, lng: 80.1270 },
                    'west tambaram': { lat: 12.9249, lng: 80.1270 },
                    'chromepet': { lat: 12.9516, lng: 80.1462 },
                    'hasthinapuram': { lat: 12.9496, lng: 80.1449 },
                    'tambaram sanatorium': { lat: 12.9265, lng: 80.1215 }
                };

                // Check if location is in known locations
                for (const [key, coords] of Object.entries(knownLocations)) {
                    if (searchName.includes(key)) {
                        console.log(`üìç Using known coordinates for ${key}:`, coords);
                        return coords;
                    }
                }

                // Special handling for Vel Tech University variations
                if (searchName.includes('vel tech') || searchName.includes('veltech')) {
                    console.log('üìç Using known coordinates for Vel Tech University');
                    return { lat: 13.0694, lng: 80.0756 };
                }

                // Add "India" to search query if not already specified for better results
                let searchQuery = locationName.trim();
                if (!searchQuery.toLowerCase().includes('india') &&
                    !searchQuery.toLowerCase().includes('chennai') &&
                    !searchQuery.toLowerCase().includes('tamil nadu')) {
                    searchQuery = `${searchQuery}, Chennai, Tamil Nadu, India`;
                }

                console.log('üåê Searching for:', searchQuery);

                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1&countrycodes=in`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('‚ùå Nominatim API error:', response.status, response.statusText);
                    return null;
                }

                const data = await response.json();
                console.log('üìç Nominatim response:', data);

                if (data && data.length > 0) {
                    const result = {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                    console.log('‚úÖ Geocoding success:', result);
                    return result;
                }

                console.error('‚ùå No geocoding results found for:', locationName);
                return null;
            } catch (e) {
                console.error('‚ùå Geocoding error:', e);
                return null;
            }
        }

        // Get real-time traffic data using multiple free services (no credit card required)
        async function getTrafficAdjustedRoute(startCoords, endCoords) {
            try {
                // Method 1: Try OpenStreetMap OSRM (Completely free, no API key)
                try {
                    const osrmResponse = await fetch(`https://router.project-osrm.org/route/v1/driving/${startCoords.lng},${startCoords.lat};${endCoords.lng},${endCoords.lat}?overview=full&geometries=geojson&steps=true&annotations=true`);

                    if (osrmResponse.ok) {
                        const data = await osrmResponse.json();
                        return processOSRMTrafficData(data);
                    }
                } catch (osrmError) {
                    console.log('OSRM routing not available, trying alternative...');
                }

                // Method 2: Try GraphHopper Routing (with API key for enhanced features)
                try {
                    const graphhopperKey = '56d0e8ca-f3d7-46fb-bd58-30c5c60888d3';
                    const graphhopperResponse = await fetch(`https://graphhopper.com/api/1/route?point=${startCoords.lat},${startCoords.lng}&point=${endCoords.lat},${endCoords.lng}&vehicle=car&debug=true&instructions=true&calc_points=true&key=${graphhopperKey}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (graphhopperResponse.ok) {
                        const data = await graphhopperResponse.json();
                        console.log('‚úÖ GraphHopper success:', data);
                        return processGraphHopperData(data);
                    } else {
                        console.log('‚ùå GraphHopper failed:', graphhopperResponse.status);
                    }
                } catch (graphhopperError) {
                    console.log('‚ùå GraphHopper error:', graphhopperError.message);
                }

                // Method 3: Try Valhalla Routing (Free, open-source)
                try {
                    const valhallaResponse = await fetch(`https://valhalla.openstreetmap.de/route?json=${encodeURIComponent(JSON.stringify({
                        locations: [
                            { lat: startCoords.lat, lon: startCoords.lng },
                            { lat: endCoords.lat, lon: endCoords.lng }
                        ],
                        costing: 'auto',
                        directions_maneuvers: 7.0
                    }))}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (valhallaResponse.ok) {
                        const data = await valhallaResponse.json();
                        return processValhallaData(data);
                    }
                } catch (valhallaError) {
                    console.log('Valhalla not available, trying alternative...');
                }

                // Method 4: Try Public Valhalla (Free, no Docker needed)
                try {
                    const valhallaResponse = await fetch(`https://valhalla.openstreetmap.de/route?json=${encodeURIComponent(JSON.stringify({
                        locations: [
                            { lat: startCoords.lat, lon: startCoords.lng },
                            { lat: endCoords.lat, lon: endCoords.lng }
                        ],
                        costing: 'auto',
                        directions_maneuvers: 7.0
                    }))}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (valhallaResponse.ok) {
                        const data = await valhallaResponse.json();
                        console.log('‚úÖ Public Valhalla success:', data);
                        return processValhallaData(data);
                    } else {
                        console.log('‚ùå Public Valhalla failed:', valhallaResponse.status);
                    }
                } catch (valhallaError) {
                    console.log('‚ùå Public Valhalla error:', valhallaError.message);
                }

                // Method 5: Try OSRM (Open Source Routing Machine) - CORS-safe, no Docker
                try {
                    const osrmResponse = await fetch(`https://router.project-osrm.org/route/v1/driving/${startCoords.lng},${startCoords.lat};${endCoords.lng},${endCoords.lat}?overview=full&geometries=geojson&steps=true&annotations=true`);

                    if (osrmResponse.ok) {
                        const data = await osrmResponse.json();
                        console.log('‚úÖ OSRM success:', data);
                        return processOSRMData(data);
                    } else {
                        console.log('‚ùå OSRM failed:', osrmResponse.status);
                    }
                } catch (osrmError) {
                    console.log('‚ùå OSRM error:', osrmError.message);
                }

                // Skip OpenRouteService due to CORS issues, use time-based fallback
                console.log('OpenRouteService blocked by CORS, using time-based fallback');
                return getTimeBasedFallback(startCoords, endCoords);

            } catch (error) {
                console.error('Traffic data error:', error);
                return getTimeBasedFallback(startCoords, endCoords);
            }
        }

        function processValhallaData(data) {
            const waypoints = [];

            if (data.trip && data.trip.legs) {
                const leg = data.trip.legs[0];

                // Valhalla provides detailed maneuver information
                leg.maneuvers.forEach((maneuver, index) => {
                    if (isSignificantWaypoint(maneuver)) {
                        const instruction = maneuver.instruction || `Waypoint ${waypoints.length + 1}`;
                        const adjustedDuration = maneuver.time; // Valhalla time is already traffic-adjusted

                        waypoints.push({
                            name: cleanInstruction(instruction),
                            coordinates: [maneuver.location.lon, maneuver.location.lat],
                            duration: adjustedDuration,
                            originalDuration: maneuver.time,
                            traffic: 'moderate', // Valhalla includes traffic optimization
                            distance: maneuver.length || 0
                        });
                    }
                });
            }

            return waypoints;
        }

        function processOpenRoutesData(data) {
            const waypoints = [];

            if (data.features && data.features.length > 0) {
                const route = data.features[0];
                const segments = route.properties.segments;

                // Extract meaningful waypoints (major turns/intersections)
                segments.forEach((segment, segIndex) => {
                    const steps = segment.steps;

                    steps.forEach((step, stepIndex) => {
                        // Only add meaningful waypoints (not every small step)
                        if (stepIndex === 0 ||
                            step.maneuver.type.includes('turn') ||
                            step.maneuver.type.includes('roundabout') ||
                            step.maneuver.type.includes('fork') ||
                            step.distance > 1000) { // Only waypoints > 1km apart

                            const instruction = step.maneuver.instruction || `Waypoint ${waypoints.length + 1}`;
                            waypoints.push({
                                name: instruction.split(',')[0] || instruction, // Clean instruction
                                distance: step.distance,
                                duration: step.duration,
                                traffic: 'moderate', // OpenRouteService includes traffic data
                                coordinates: step.maneuver.location
                            });
                        }
                    });
                });
            }

            return waypoints;
        }

        function processOSRMTrafficData(data) {
            const waypoints = [];

            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const legs = route.legs[0];

                // OSRM provides distance and duration, we can estimate traffic
                const baseDuration = legs.duration; // Base travel time in seconds
                const distance = legs.distance; // Distance in meters

                // Estimate traffic based on time of day and distance
                const trafficEstimate = estimateTrafficFromTimeAndDistance(baseDuration, distance);

                legs.steps.forEach((step, index) => {
                    const adjustedDuration = step.duration * trafficEstimate.multiplier;

                    if (isSignificantWaypoint(step)) {
                        waypoints.push({
                            name: cleanInstruction(step.maneuver.instruction || step.maneuver.type),
                            coordinates: [step.maneuver.location[0], step.maneuver.location[1]],
                            duration: adjustedDuration,
                            originalDuration: step.duration,
                            traffic: trafficEstimate.level,
                            distance: step.distance
                        });
                    }
                });
            }

            return waypoints;
        }

        function processGraphHopperData(data) {
            const waypoints = [];

            if (data.paths && data.paths.length > 0) {
                const path = data.paths[0];

                // GraphHopper provides time and distance
                const baseDuration = path.time * 1000; // Convert to seconds
                const distance = path.distance; // Distance in meters

                // Estimate traffic based on current time
                const trafficEstimate = estimateTrafficFromTimeAndDistance(baseDuration, distance);

                if (path.instructions) {
                    path.instructions.forEach((instruction, index) => {
                        if (isSignificantWaypoint(instruction)) {
                            const adjustedDuration = instruction.time * 1000 * trafficEstimate.multiplier;

                            waypoints.push({
                                name: cleanInstruction(instruction.text || instruction.instruction),
                                coordinates: [instruction.point[0], instruction.point[1]],
                                duration: adjustedDuration,
                                originalDuration: instruction.time * 1000,
                                traffic: trafficEstimate.level,
                                distance: instruction.distance
                            });
                        }
                    });
                }
            }

            return waypoints;
        }

        function estimateTrafficFromTimeAndDistance(duration, distance) {
            const now = new Date();
            const hour = now.getHours();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 6 = Saturday

            // Base speed calculation (km/h)
            const baseSpeed = (distance / 1000) / (duration / 3600);

            // Traffic patterns by time and day (weekday vs weekend)
            let trafficMultiplier = 1.0;
            let trafficLevel = 'moderate';

            // Weekend patterns (less traffic)
            if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                if (hour >= 10 && hour < 14) {
                    trafficMultiplier = 1.2; // Weekend midday
                    trafficLevel = 'moderate';
                } else if (hour >= 18 && hour < 21) {
                    trafficMultiplier = 1.3; // Weekend evening
                    trafficLevel = 'moderate';
                } else {
                    trafficMultiplier = 0.9; // Weekend other times
                    trafficLevel = 'light';
                }
            } else { // Weekday patterns
                if (hour >= 7 && hour < 10) {
                    trafficMultiplier = 1.7; // Weekday morning rush
                    trafficLevel = 'heavy';
                } else if (hour >= 17 && hour < 20) {
                    trafficMultiplier = 1.8; // Weekday evening rush
                    trafficLevel = 'heavy';
                } else if (hour >= 11 && hour < 16) {
                    trafficMultiplier = 1.1; // Weekday lunch hours
                    trafficLevel = 'light';
                } else {
                    trafficMultiplier = 1.3; // Weekday other times
                    trafficLevel = 'moderate';
                }
            }

            // Adjust for unusually slow speeds (indicating traffic)
            if (baseSpeed < 15 && trafficMultiplier === 1.0) {
                trafficMultiplier = 1.4; // Assume moderate traffic if very slow
                trafficLevel = 'moderate';
            }

            return {
                multiplier: trafficMultiplier,
                level: trafficLevel,
                estimatedDelay: Math.round((trafficMultiplier - 1) * duration / 60) // minutes
            };
        }

        function isSignificantWaypoint(step) {
            // Determine if this step should be a waypoint
            return step.maneuver.type.includes('turn') ||
                step.maneuver.type.includes('roundabout') ||
                step.maneuver.type.includes('fork') ||
                step.distance > 1000 ||
                (step.annotation?.congestion && step.annotation.congestion !== 'low');
        }

        function cleanInstruction(instruction) {
            // Clean up navigation instructions
            return instruction.split(',')[0] || instruction;
        }

        function getTimeBasedFallback(startCoords, endCoords) {
            // Fallback: Use time-based traffic estimation
            const now = new Date();
            const hour = now.getHours();

            // Define traffic patterns by hour (typical urban patterns)
            const trafficPatterns = {
                '0-6': 0.8,    // Late night/early morning - light traffic
                '6-9': 1.6,    // Morning rush - heavy traffic
                '9-11': 1.2,   // Mid-morning - moderate traffic
                '11-16': 1.1,  // Midday - light-moderate traffic
                '16-19': 1.8,   // Evening rush - very heavy traffic
                '19-22': 1.3,   // Evening - moderate traffic
                '22-24': 0.9    // Night - light traffic
            };

            let trafficMultiplier = 1.0;
            for (const [range, multiplier] of Object.entries(trafficPatterns)) {
                const [start, end] = range.split('-').map(Number);
                if (hour >= start && hour < end) {
                    trafficMultiplier = multiplier;
                    break;
                }
            }

            // Apply time-based adjustment to route
            return {
                trafficMultiplier: trafficMultiplier,
                trafficLevel: trafficMultiplier > 1.5 ? 'heavy' :
                    trafficMultiplier > 1.2 ? 'moderate' : 'light',
                estimatedDelay: Math.round((trafficMultiplier - 1) * 60) // minutes
            };
        }

        // Get meaningful waypoints using available routing APIs (no Docker needed)
        async function getRouteWaypoints(startCoords, endCoords) {
            try {
                // Try OSRM first (CORS-safe, completely free)
                try {
                    const osrmResponse = await fetch(`https://router.project-osrm.org/route/v1/driving/${startCoords.lng},${startCoords.lat};${endCoords.lng},${endCoords.lat}?overview=full&geometries=geojson&steps=true&annotations=true`);

                    if (osrmResponse.ok) {
                        const data = await osrmResponse.json();
                        console.log('‚úÖ OSRM route success:', data);
                        return processOSRMData(data);
                    }
                } catch (osrmError) {
                    console.log('‚ùå OSRM failed:', osrmError.message);
                }

                // Try GraphHopper with API key
                try {
                    const graphhopperKey = '56d0e8ca-f3d7-46fb-bd58-30c5c60888d3';
                    const graphhopperResponse = await fetch(`https://graphhopper.com/api/1/route?point=${startCoords.lat},${startCoords.lng}&point=${endCoords.lat},${endCoords.lng}&vehicle=car&instructions=true&calc_points=true&key=${graphhopperKey}`);

                    if (graphhopperResponse.ok) {
                        const data = await graphhopperResponse.json();
                        console.log('‚úÖ GraphHopper route success:', data);
                        return processGraphHopperData(data);
                    }
                } catch (graphhopperError) {
                    console.log('‚ùå GraphHopper failed:', graphhopperError.message);
                }

                // Try Valhalla as last resort
                try {
                    const valhallaResponse = await fetch(`https://valhalla.openstreetmap.de/route?json=${encodeURIComponent(JSON.stringify({
                        locations: [
                            { lat: startCoords.lat, lon: startCoords.lng },
                            { lat: endCoords.lat, lon: endCoords.lng }
                        ],
                        costing: 'auto',
                        directions_maneuvers: 7.0
                    }))}`, {
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (valhallaResponse.ok) {
                        const data = await valhallaResponse.json();
                        console.log('‚úÖ Valhalla route success:', data);
                        return processValhallaData(data);
                    }
                } catch (valhallaError) {
                    console.log('‚ùå Valhalla failed:', valhallaError.message);
                }

                // All APIs failed, return empty array
                console.log('‚ùå All routing APIs failed');
                return [];

            } catch (error) {
                console.error('Route waypoints error:', error);
                return [];
            }
        }

        // Process OSRM data
        function processOSRMData(response) {
            try {
                const data = response; // Use response parameter instead of undefined data
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const legs = route.legs;
                    const waypoints = [];

                    legs.forEach((leg, legIndex) => {
                        leg.steps.forEach((step, index) => {
                            // Filter for significant turns/maneuvers
                            if (step.maneuver && step.maneuver.type !== 'arrive' && step.maneuver.type !== 'depart' && step.distance > 500) {
                                waypoints.push({
                                    name: step.maneuver.instruction || step.name || `Waypoint ${legIndex}-${index}`,
                                    distance: step.distance,
                                    duration: step.duration,
                                    traffic: 'moderate', // OSRM public doesn't provide real-time traffic
                                    coordinates: step.maneuver.location || [step.maneuver.location[1], step.maneuver.location[0]]
                                });
                            }
                        });
                    });

                    return waypoints;
                }
            } catch (error) {
                console.error('Error processing OSRM data:', error);
                return [];
            }
        }

        async function optimizeRouteWithAI() {
            const startPoint = document.getElementById('start-point').value.trim();
            const endPoint = document.getElementById('end-point').value.trim();
            const routeNameInput = document.getElementById('route-name');
            const stopsBuilder = document.getElementById('stops-builder');
            const optimizeBtn = document.getElementById('ai-optimize-btn');

            if (!startPoint || !endPoint) {
                showMessage('Please enter both start and end points for AI optimization', 'error');
                return;
            }

            // Show loading state
            optimizeBtn.disabled = true;
            optimizeBtn.textContent = 'üîÑ Optimizing...';
            showLoading();

            try {
                // Convert location names to coordinates using Nominatim API
                const [startCoords, endCoords] = await Promise.all([
                    geocodeLocation(startPoint),
                    geocodeLocation(endPoint)
                ]);

                if (!startCoords || !endCoords) {
                    let errorMsg = 'Could not geocode locations: ';
                    if (!startCoords && !endCoords) {
                        errorMsg += 'Both start and end points not found. Please check the location names.';
                    } else if (!startCoords) {
                        errorMsg += `Start point "${startPoint}" not found. Please check the spelling.`;
                    } else {
                        errorMsg += `End point "${endPoint}" not found. Please check the spelling.`;
                    }
                    throw new Error(errorMsg);
                }

                // Get meaningful waypoints using OpenRouteService
                const waypoints = await getRouteWaypoints(startCoords, endCoords);

                // Generate route name if empty
                if (!routeNameInput.value) {
                    routeNameInput.value = `${startPoint} to ${endPoint}`;
                }

                // Clear existing stops
                stopsBuilder.innerHTML = '';

                // Add optimized stops (limited to meaningful waypoints)
                const optimizedStops = [];
                let cumulativeTime = 0; // Track cumulative time from start

                // Add start point
                optimizedStops.push({
                    name: startPoint,
                    eta: 'Start'
                });

                // Add intermediate waypoints (limit to reasonable number)
                const maxWaypoints = 8; // Limit to prevent too many stops
                const selectedWaypoints = waypoints.slice(0, maxWaypoints);

                // Get traffic information for display
                const trafficInfo = selectedWaypoints.length > 0 ? selectedWaypoints[0].traffic : 'moderate';
                const estimatedDelay = selectedWaypoints.length > 0 ?
                    Math.round(selectedWaypoints.reduce((sum, wp) => sum + (wp.duration - wp.originalDuration), 0) / 60) : 0;

                selectedWaypoints.forEach((waypoint, index) => {
                    cumulativeTime += waypoint.duration; // Add this waypoint's duration
                    const totalMinutes = Math.round(cumulativeTime / 60); // Convert to minutes
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;

                    // Format as HH:MM AM/PM
                    let timeString;
                    if (hours === 0) {
                        timeString = `12:${minutes.toString().padStart(2, '0')} AM`;
                    } else if (hours < 12) {
                        timeString = `${hours}:${minutes.toString().padStart(2, '0')} AM`;
                    } else if (hours === 12) {
                        timeString = `12:${minutes.toString().padStart(2, '0')} PM`;
                    } else {
                        timeString = `${hours - 12}:${minutes.toString().padStart(2, '0')} PM`;
                    }

                    optimizedStops.push({
                        name: waypoint.name,
                        eta: timeString,
                        traffic: waypoint.traffic
                    });
                });

                // Add end point
                if (selectedWaypoints.length > 0) {
                    // Add final segment time from last waypoint to destination
                    const totalRouteDuration = selectedWaypoints.reduce((sum, wp) => sum + wp.duration, 0);
                    const finalMinutes = Math.round(totalRouteDuration / 60);
                    const finalHours = Math.floor(finalMinutes / 60);
                    const finalMins = finalMinutes % 60;

                    let finalTimeString;
                    if (finalHours === 0) {
                        finalTimeString = `12:${finalMins.toString().padStart(2, '0')} AM`;
                    } else if (finalHours < 12) {
                        finalTimeString = `${finalHours}:${finalMins.toString().padStart(2, '0')} AM`;
                    } else if (finalHours === 12) {
                        finalTimeString = `12:${finalMins.toString().padStart(2, '0')} PM`;
                    } else {
                        finalTimeString = `${finalHours - 12}:${finalMins.toString().padStart(2, '0')} PM`;
                    }

                    optimizedStops.push({
                        name: endPoint,
                        eta: finalTimeString,
                        traffic: 'destination'
                    });
                } else {
                    // No intermediate waypoints, just show destination
                    optimizedStops.push({
                        name: endPoint,
                        eta: 'Destination',
                        traffic: 'unknown'
                    });
                }

                // Add stops to the builder
                optimizedStops.forEach((stop, index) => {
                    addStopRow(stop.name, stop.eta);
                });

                // Update the hidden textarea
                updateStopsData();

                hideLoading();

                // Show traffic-aware success message
                const trafficEmoji = trafficInfo === 'heavy' ? 'üî¥' :
                    trafficInfo === 'moderate' ? 'üü°' : 'üü¢';
                showMessage(`${trafficEmoji} AI optimized route with ${optimizedStops.length - 2} intermediate stops (${trafficInfo} traffic, +${estimatedDelay}min delay)`, 'success');
            } catch (error) {
                console.error('AI Route Optimization error:', error);
                hideLoading();
                showMessage('AI Route Optimization error: ' + error.message, 'error');
                stopsBuilder.innerHTML = '';
                mockStops.forEach(stop => addStopRow(stop.name, stop.eta));
                updateStopsData();

                showMessage('‚ö†Ô∏è Using offline optimization. Route suggested with standard stops.', 'warning');
            } finally {
                optimizeBtn.disabled = false;
                optimizeBtn.textContent = 'Optimize Route';
            }
        }

        function addStopRow(name = '', eta = '') {
            const stopsBuilder = document.getElementById('stops-builder');
            const stopRow = document.createElement('div');
            stopRow.className = 'flex gap-2 items-center';
            stopRow.innerHTML = `
                <input type="text" placeholder="Stop name" value="${name}" class="flex-1 px-1 py-1 text-xs border border-gray-300 rounded-md stop-name">
                <input type="text" placeholder="ETA" value="${eta}" class="w-16 px-1 py-1 text-xs border border-gray-300 rounded-md stop-eta">
                <button type="button" class="px-1 py-1 text-xs bg-green-500 text-white rounded-md hover:bg-green-600 add-stop">+</button>
                <button type="button" class="px-1 py-1 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 remove-stop">Remove</button>
            `;
            stopsBuilder.appendChild(stopRow);

            // Add remove functionality
            stopRow.querySelector('.remove-stop').addEventListener('click', () => {
                stopRow.remove();
                updateStopsData();
            });

            // Add functionality for + button to insert new stop after current one
            stopRow.querySelector('.add-stop').addEventListener('click', () => {
                const newStopRow = addStopRow('', '');
                stopsBuilder.insertBefore(newStopRow, stopRow.nextSibling);
                updateStopsData();
            });

            // Add change listeners to update data and map
            stopRow.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    updateStopsData();
                });
            });

            return stopRow;
        }

        function updateStopsData() {
            const stopsBuilder = document.getElementById('stops-builder');
            const stopsDataTextarea = document.getElementById('stops-data');
            const stops = [];

            stopsBuilder.querySelectorAll('.flex').forEach(row => {
                const name = row.querySelector('.stop-name')?.value || '';
                const eta = row.querySelector('.stop-eta')?.value || '';
                if (name) {
                    stops.push({ name, eta });
                }
            });

            stopsDataTextarea.value = JSON.stringify(stops);

            // Note: Auto-sync removed - routes are only saved when admin clicks "Add Bus" button
            // This prevents accidental database saves when using "Optimize Route" feature
        }

        // Sync stops to bus schedules in database
        async function syncStopsToBusSchedule() {
            if (!window.supabaseClient) return;

            const busNumber = document.getElementById('bus-number')?.value;
            const routeName = document.getElementById('route-name')?.value;
            const stopsDataTextarea = document.getElementById('stops-data');

            if (!busNumber || !routeName || !stopsDataTextarea?.value) return;

            try {
                const stops = JSON.parse(stopsDataTextarea.value);

                // Check if bus number already exists before syncing
                const { data: existingRoutes, error: checkError } = await window.supabaseClient
                    .from('bus_routes')
                    .select('route_number')
                    .eq('route_number', busNumber);

                if (checkError) {
                    console.error('Error checking existing route:', checkError);
                    showMessage('Database error while checking for existing routes');
                    return;
                } else if (existingRoutes && existingRoutes.length > 0) {
                    showMessage(`‚ùå Bus Number "${busNumber}" already exists in database. Please use a different bus number.`);
                    showMessage('üí° Each bus must have a unique identifier. Current conflicts: ' + existingRoutes.map(r => r.route_number).join(', '));
                    return;
                }

                // Additional validation: check if route number format is valid
                if (!busNumber.match(/^[A-Z0-9]{3,6}$/)) {
                    showMessage('‚ùå Invalid Bus Number format. Please use format like "R001", "R002", etc.');
                    return;
                }

                // Get departure time and ETA inputs
                const departureTimeInput = document.getElementById('departure-time')?.value;
                const departureAmpm = document.getElementById('departure-ampm')?.value;
                const etaInput = document.getElementById('eta')?.value;
                const etaAmpm = document.getElementById('eta-ampm')?.value;

                // Convert 12h to 24h format
                const departureTime24 = convertTo24h(departureTimeInput, departureAmpm);
                const etaTime24 = convertTo24h(etaInput, etaAmpm);

                // Calculate time intervals between stops
                const totalStops = stops.length;
                const timeIntervals = calculateTimeIntervals(departureTime24, etaTime24, totalStops);

                // Update stops with calculated times
                const updatedStops = stops.map((stop, index) => ({
                    ...stop,
                    time: timeIntervals[index] || departureTime24,
                    eta: timeIntervals[index] || departureTime24
                }));

                // Create route JSON object with times
                const routeJson = {
                    busNo: busNumber,
                    route: routeName,
                    departureTime: departureTime24,
                    eta: etaTime24,
                    stops: updatedStops
                };

                // Show loading indicator for immediate user feedback
                showMessage('üîÑ Adding bus, please wait...');

                // Call the database sync_route function with correct parameter type
                const { error } = await window.supabaseClient.rpc('sync_route', {
                    route_json: routeJson // Pass as object for json parameter
                });

                if (error) {
                    console.error('Error syncing route to database:', error);
                    showMessage(`‚ùå Failed to sync route: ${error.message}`);
                    if (error.message?.includes('permission denied') || error.message?.includes('function')) {
                        showMessage('‚ö†Ô∏è Database permission error. The sync_route function may not be properly configured in your Supabase project.');
                        showMessage('üîß To fix: Go to Supabase Dashboard ‚Üí SQL Editor ‚Üí Create RPC function sync_route');
                        showMessage('üí° Alternative: Try using direct database operations instead.');

                        // Try direct database operation as fallback
                        try {
                            // First, insert the main route
                            const { data: routeData, error: routeError } = await window.supabaseClient
                                .from('bus_routes')
                                .insert({
                                    route_number: busNumber,
                                    route_name: routeName
                                })
                                .select('id')
                                .single();

                            if (routeError) {
                                showMessage(`Fallback operation failed: ${routeError.message}`);
                                return;
                            }

                            // Then insert the stops into route_stops junction table
                            if (stops && stops.length > 0) {
                                // First, ensure all stops exist in bus_stops table
                                const stopInserts = [];
                                for (const stop of stops) {
                                    // Check if stop already exists
                                    const { data: existingStop } = await window.supabaseClient
                                        .from('bus_stops')
                                        .select('id')
                                        .eq('stop_name', stop.name)
                                        .single();

                                    let stopId;
                                    if (existingStop) {
                                        stopId = existingStop.id;
                                    } else {
                                        // Insert new stop
                                        const { data: newStop } = await window.supabaseClient
                                            .from('bus_stops')
                                            .insert({ stop_name: stop.name })
                                            .select('id')
                                            .single();
                                        stopId = newStop.id;
                                    }

                                    stopInserts.push({
                                        route_id: routeData.id,
                                        stop_id: parseInt(stopId),
                                        sequence_order: stopInserts.length + 1,
                                        estimated_arrival_time: stop.time || '00:00:00'
                                    });
                                }

                                const { error: stopsError } = await window.supabaseClient
                                    .from('route_stops')
                                    .insert(stopInserts);

                                if (stopsError) {
                                    showMessage(`Stops insertion failed: ${stopsError.message}`);
                                    return;
                                }
                            }

                            showMessage('‚úÖ Route saved using direct database operation (fallback method)');
                            loadUnifiedRoutes();
                        } catch (fallbackException) {
                            console.error('Fallback operation exception:', fallbackException);
                            showMessage(`Fallback operation error: ${fallbackException.message}`);
                        }
                    } else if (error.message?.includes('duplicate') || error.message?.includes('unique') || error.message?.includes('constraint')) {
                        showMessage(`‚ùå Bus Number "${busNumber}" already exists. Please use a different bus number.`);
                        showMessage('üí° Tip: Each bus must have a unique identifier.');
                    } else {
                        showMessage(`Failed to sync route: ${error.message}`);
                    }
                } else {
                    console.log('Route synced to database successfully');
                    showMessage('‚úÖ Route synced to database successfully!');
                    loadUnifiedRoutes(); // Refresh the routes table
                }
            } catch (e) {
                console.error('Error in syncStopsToBusSchedule:', e);
                showMessage(`Error syncing route: ${e.message}`);
            }
        }

        // --- Time Calculation Helper Functions ---

        // Convert 12h format to 24h format
        function convertTo24h(time12h, ampm) {
            if (!time12h) return '00:00';

            const [hours, minutes] = time12h.split(':').map(Number);
            let hours24 = hours;

            if (ampm === 'PM' && hours !== 12) {
                hours24 += 12;
            } else if (ampm === 'AM' && hours === 12) {
                hours24 = 0;
            }

            return `${hours24.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Calculate time intervals between stops
        function calculateTimeIntervals(departureTime, etaTime, totalStops) {
            if (!departureTime || !etaTime || totalStops <= 1) {
                return [departureTime];
            }

            // Parse times to minutes
            const [depHours, depMinutes] = departureTime.split(':').map(Number);
            const [etaHours, etaMinutes] = etaTime.split(':').map(Number);

            const depTotalMinutes = depHours * 60 + depMinutes;
            const etaTotalMinutes = etaHours * 60 + etaMinutes;

            // Handle crossing midnight
            let totalDuration = etaTotalMinutes - depTotalMinutes;
            if (totalDuration < 0) {
                totalDuration += 24 * 60; // Add 24 hours
            }

            // Calculate interval between stops
            const intervalMinutes = Math.floor(totalDuration / (totalStops - 1));

            // Generate time for each stop
            const times = [];
            for (let i = 0; i < totalStops; i++) {
                const currentMinutes = depTotalMinutes + (i * intervalMinutes);
                const adjustedMinutes = currentMinutes % (24 * 60); // Handle overflow

                const hours = Math.floor(adjustedMinutes / 60);
                const minutes = adjustedMinutes % 60;

                times.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
            }

            return times;
        }

        // --- Form UX: Enter key navigation and time syncing ---
        function focusNextFormControl(fromEl) {
            const controls = Array.from(addBusForm.querySelectorAll('input, button, textarea, select'))
                .filter(el => !el.disabled && el.type !== 'hidden' && el.offsetParent !== null);
            const idx = controls.indexOf(fromEl);
            if (idx >= 0 && idx < controls.length - 1) {
                controls[idx + 1].focus();
            }
        }

        function normalizeEmergencyRow(row) {
            if (!row) return null;
            return {
                id: row.id,
                incident_type: row.incident_type,
                reported_by_type: row.reported_by_type,
                reported_by_id: row.reported_by_id,
                bus_no: row.bus_no,
                route_id: row.route_id,
                location_lat: row.location_lat,
                location_lng: row.location_lng,
                description: row.description,
                severity: row.severity,
                status: row.status,
                created_at: row.created_at,
                message: row.message // optional in case of notifications join
            };
        }

        async function deleteOldEmergencyAlerts() {
            if (!window.supabaseClient) return;
            try {
                // Delete emergency alerts older than 15 days
                const fifteenDaysAgo = new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString();
                const { error } = await window.supabaseClient
                    .from('emergency_incidents')
                    .delete()
                    .lt('created_at', fifteenDaysAgo);

                if (error) {
                    console.warn('Could not auto-delete old emergency alerts (check RLS policies):', error.message);
                } else {
                    console.log('Old emergency alerts cleanup complete.');
                }
            } catch (e) {
                console.error('Error in deleteOldEmergencyAlerts:', e);
            }
        }

        async function loadEmergencyAlerts(initial = false) {
            if (!window.supabaseClient) return;
            try {
                // Cleanup old alerts first
                if (initial) {
                    await deleteOldEmergencyAlerts();
                }

                const { data, error } = await window.supabaseClient
                    .from('emergency_incidents')
                    .select('id, incident_type, reported_by_type, reported_by_id, bus_no, route_id, location_lat, location_lng, description, severity, status, created_at')
                    .order('created_at', { ascending: false })
                    .limit(25);
                if (error) throw error;
                emergencyAlerts = (data || []).map(normalizeEmergencyRow).filter(Boolean);
                if (initial && !emergencyLastSeen) {
                    emergencyLastSeen = loadEmergencyLastSeen();
                }
                renderEmergencyAlerts();
            } catch (e) {
                console.error('loadEmergencyAlerts error', e);
                if (emergencyAlertsList) {
                    emergencyAlertsList.innerHTML = '<p class="text-red-600">Failed to load emergency alerts.</p>';
                }
            }
        }

        let _emergencyChannel = null;

        function subscribeEmergencyAlerts() {
            try {
                if (!window.supabaseClient || _emergencyChannel) return;
                _emergencyChannel = window.supabaseClient
                    .channel('emergency_incidents_live_admin')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'emergency_incidents' }, (payload) => {
                        try {
                            const row = payload.new || payload.old || null;
                            if (payload.eventType === 'DELETE') {
                                emergencyAlerts = emergencyAlerts.filter(alert => alert.id !== (row && row.id));
                            } else if (row) {
                                const normalized = normalizeEmergencyRow(row);
                                if (!normalized) return;
                                const idx = emergencyAlerts.findIndex(alert => alert.id === normalized.id);
                                if (idx >= 0) {
                                    emergencyAlerts[idx] = normalized;
                                } else {
                                    emergencyAlerts.unshift(normalized);
                                }
                            }
                            emergencyAlerts = emergencyAlerts
                                .filter(Boolean)
                                .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
                            renderEmergencyAlerts();
                        } catch (err) {
                            console.error('Realtime emergency alert error', err);
                        }
                    })
                    .subscribe();
            } catch (e) {
                console.error('subscribeEmergencyAlerts error', e);
            }
        }

        function setStudentSubtab(tab) {
            const showLogins = tab === 'logins';
            const showEmergencies = tab === 'emergencies';
            const showNotifications = tab === 'notifications';

            if (studentsSubtabLogins) {
                studentsSubtabLogins.classList.toggle('bg-blue-600', showLogins);
                studentsSubtabLogins.classList.toggle('text-white', showLogins);
                studentsSubtabLogins.classList.toggle('text-gray-600', !showLogins);
                studentsSubtabLogins.classList.toggle('bg-gray-200', !showLogins);
            }
            if (studentsSubtabEmergencies) {
                studentsSubtabEmergencies.classList.toggle('bg-blue-600', showEmergencies);
                studentsSubtabEmergencies.classList.toggle('text-white', showEmergencies);
                studentsSubtabEmergencies.classList.toggle('text-gray-600', !showEmergencies);
                studentsSubtabEmergencies.classList.toggle('bg-gray-200', !showEmergencies);
            }
            if (studentsSubtabNotifications) {
                studentsSubtabNotifications.classList.toggle('bg-blue-600', showNotifications);
                studentsSubtabNotifications.classList.toggle('text-white', showNotifications);
                studentsSubtabNotifications.classList.toggle('text-gray-600', !showNotifications);
                studentsSubtabNotifications.classList.toggle('bg-gray-200', !showNotifications);
            }
            if (studentLoginsPanel) studentLoginsPanel.classList.toggle('hidden', !showLogins);
            if (emergencyAlertsPanel) emergencyAlertsPanel.classList.toggle('hidden', !showEmergencies);
            if (notificationsPanel) notificationsPanel.classList.toggle('hidden', !showNotifications);
        }

        if (studentsSubtabLogins) {
            studentsSubtabLogins.addEventListener('click', () => setStudentSubtab('logins'));
        }
        if (studentsSubtabEmergencies) {
            studentsSubtabEmergencies.addEventListener('click', () => setStudentSubtab('emergencies'));
        }
        if (studentsSubtabNotifications) {
            studentsSubtabNotifications.addEventListener('click', () => setStudentSubtab('notifications'));
        }
        setStudentSubtab('logins');

        if (addBusForm) {
            addBusForm.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                const target = e.target;
                if (!(target instanceof HTMLElement)) return;
                // If focus is on the submit button, allow normal submit
                if (
                    target.id === 'submit-btn' ||
                    (target.tagName === 'BUTTON' && ((target).type === 'submit' || target.getAttribute('type') === 'submit'))
                ) {
                    return;
                }
                // Prevent premature submit elsewhere
                e.preventDefault();

                // Stop-row specific navigation
                const row = target.closest('.stop-row');
                if (row) {
                    if (target.classList.contains('stop-name')) {
                        const t = row.querySelector('.stop-time');
                        if (t) { t.focus(); return; }
                    } else if (target.classList.contains('stop-time')) {
                        const a = row.querySelector('.stop-ampm');
                        if (a) { a.focus(); return; }
                    } else if (target.classList.contains('stop-ampm')) {
                        const next = row.nextElementSibling && row.nextElementSibling.classList.contains('stop-row')
                            ? row.nextElementSibling
                            : null;
                        if (next) {
                            const nextName = next.querySelector('.stop-name');
                            if (nextName) { nextName.focus(); return; }
                        } else {
                            // Add a new row and focus its name
                            addStopRow('', '');
                            const rows = stopsBuilder.querySelectorAll('.stop-row');
                            const last = rows[rows.length - 1];
                            const nameEl = last?.querySelector('.stop-name');
                            if (nameEl) { nameEl.focus(); return; }
                        }
                    }
                }

                // Generic navigation through main controls
                focusNextFormControl(target);
            });
        }

        // When top-level times change, push to first/last stop to keep consistent
        function pushDepartureToFirstStop() {
            if (!stopsBuilder) return;
            const rows = Array.from(stopsBuilder.querySelectorAll('.stop-row'));
            if (rows.length === 0) { addStopRow('', ''); }
            const allRows = Array.from(stopsBuilder.querySelectorAll('.stop-row'));
            const first = allRows[0];
            const dep12 = (departureTimeInput?.value || '').slice(0, 5);
            const depAm = (departureAmPm?.value || 'AM');
            if (first) {
                const ft = first.querySelector('.stop-time');
                const fa = first.querySelector('.stop-ampm');
                if (ft) ft.value = dep12;
                if (fa) fa.value = depAm;
            }
            suppressTopLevelSync = true;
            updateStopsTextarea();
            suppressTopLevelSync = false;
        }

        function pushEtaToLastStop() {
            if (!stopsBuilder) return;
            const rows = Array.from(stopsBuilder.querySelectorAll('.stop-row'));
            if (rows.length === 0) { addStopRow('', ''); }
            const allRows = Array.from(stopsBuilder.querySelectorAll('.stop-row'));
            const last = allRows[allRows.length - 1];
            const eta12 = (etaInput?.value || '').slice(0, 5);
            const etaAm = (etaAmPm?.value || 'AM');
            if (last) {
                const lt = last.querySelector('.stop-time');
                const la = last.querySelector('.stop-ampm');
                if (lt) lt.value = eta12;
                if (la) la.value = etaAm;
            }
            suppressTopLevelSync = true;
            updateStopsTextarea();
            suppressTopLevelSync = false;
        }

        if (departureTimeInput) {
            departureTimeInput.addEventListener('change', pushDepartureToFirstStop);
            departureTimeInput.addEventListener('input', pushDepartureToFirstStop);
        }
        if (etaInput) {
            etaInput.addEventListener('change', pushEtaToLastStop);
            etaInput.addEventListener('input', pushEtaToLastStop);
        }
        if (departureAmPm) {
            departureAmPm.addEventListener('change', pushDepartureToFirstStop);
            departureAmPm.addEventListener('input', pushDepartureToFirstStop);
        }
        if (etaAmPm) {
            etaAmPm.addEventListener('change', pushEtaToLastStop);
            etaAmPm.addEventListener('input', pushEtaToLastStop);
        }

        function redirectToExternalMap() {
            const lat = 13.177470064893306;
            const lng = 80.09811982470028;
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            try { window.open(url, '_blank'); } catch (_) { }
        }

        // Initializes the Leaflet map for the college location (id: 'college-map')
        function initCollegeMap() {
            try {
                const mapEl = document.getElementById('college-map');
                if (!mapEl || !window.L) { return; }
                // Ensure container has some height in case CSS hasn't applied
                if (!mapEl.style.height || mapEl.clientHeight === 0) {
                    mapEl.style.height = '14rem';
                }
                // Avoid re-initializing if already created
                if (window._collegeMap) {
                    try {
                        window._collegeMap.setView([13.177470064893306, 80.09811982470028], 16);
                        if (window._collegeMarker) {
                            window._collegeMarker.setLatLng([13.177470064893306, 80.09811982470028]);
                        }
                        window._collegeMap.off('click');
                        window._collegeMap.on('click', redirectToExternalMap);
                        setTimeout(() => window._collegeMap.invalidateSize(), 0);
                    } catch (_) { }
                    return;
                }

                const lat = 13.177470064893306;
                const lng = 80.09811982470028;

                const map = window.L.map('college-map', { zoomControl: true });
                window._collegeMap = map;
                map.setView([lat, lng], 16);
                map.on('click', redirectToExternalMap);

                window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                window._collegeMarker = window.L.marker([lat, lng]).addTo(map).bindPopup('Vel Tech University');

                // Ensure proper sizing after being shown
                try { setTimeout(() => map.invalidateSize(), 0); } catch (_) { }
            } catch (e) {
                try { console.warn('initCollegeMap error', e); } catch (_) { }
            }
        }

        // --- Live bus markers (Admin) ---
        let _adminBusMarkers = new Map();
        let _adminBusPollTimer = null;
        let _busPosChannel = null;
        let _adminBusTrails = new Map();

        function upsertBusMarkerAdmin(busNo, lat, lng, routeInfo) {
            try {
                if (!window._collegeMap || !window.L) return;
                const pos = [lat, lng];

                // Determine display label: use route if available, otherwise bus number
                const displayLabel = routeInfo
                    ? `${routeInfo.routeNumber}${routeInfo.routeName ? ' - ' + routeInfo.routeName : ''}`
                    : `Bus ${busNo}`;

                if (_adminBusMarkers.has(busNo)) {
                    const marker = _adminBusMarkers.get(busNo);
                    marker.setLatLng(pos);
                    // Update tooltip with new route info
                    marker.setTooltipContent(displayLabel);
                } else {
                    const busIcon = window.L.divIcon({
                        className: 'custom-bus-icon',
                        html: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h-2l-2-2h-4L8 4H6C5 4 4 5 4 6v10c0 1 1 2 2 2h10c1 0 2-1 2-2V6c0-1-1-2-2-2zm-6 14H8v-2h2v2zm4 0h-2v-2h2v2zm-6-4H6V6h12v8h-2V8h-8v6z" fill="#EF4444"/><circle cx="8" cy="18" r="1.5" fill="#EF4444"/><circle cx="14" cy="18" r="1.5" fill="#EF4444"/></svg>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    const mk = window.L.marker(pos, { icon: busIcon, title: displayLabel })
                        .addTo(window._collegeMap)
                        .bindTooltip(displayLabel);
                    _adminBusMarkers.set(busNo, mk);
                }
                upsertBusTrailAdmin(busNo, lat, lng);
            } catch (_) { }
        }

        function removeBusMarkerAdmin(busNo) {
            try {
                if (_adminBusMarkers && _adminBusMarkers.has(busNo)) {
                    const mk = _adminBusMarkers.get(busNo);
                    try { window._collegeMap.removeLayer(mk); } catch (_) { }
                    _adminBusMarkers.delete(busNo);
                }
                removeBusTrailAdmin(busNo);
            } catch (_) { }
        }

        function upsertBusTrailAdmin(busNo, lat, lng) {
            try {
                if (!window._collegeMap || !window.L) return;
                const key = String(busNo);
                const pos = [lat, lng];
                let o = _adminBusTrails.get(key);
                if (!o) {
                    const poly = window.L.polyline([pos], { color: '#111827', weight: 3, opacity: 0.9 });
                    poly.addTo(window._collegeMap);
                    _adminBusTrails.set(key, { poly, points: [pos] });
                } else {
                    const pts = o.points;
                    const last = pts[pts.length - 1];
                    if (!last || last[0] !== lat || last[1] !== lng) {
                        pts.push(pos);
                        if (pts.length > 50) { pts.shift(); }
                        o.poly.setLatLngs(pts);
                    }
                }
            } catch (_) { }
        }

        function removeBusTrailAdmin(busNo) {
            try {
                const key = String(busNo);
                if (_adminBusTrails && _adminBusTrails.has(key)) {
                    const o = _adminBusTrails.get(key);
                    try { window._collegeMap.removeLayer(o.poly); } catch (_) { }
                    _adminBusTrails.delete(key);
                }
            } catch (_) { }
        }

        async function loadCurrentBusPositionsAdmin() {
            try {
                if (!window.supabaseClient) return;

                // Get bus positions with their assigned routes
                const { data: positions, error: posError } = await window.supabaseClient
                    .from('bus_positions')
                    .select('bus_no, lat, lng');

                if (posError || !Array.isArray(positions)) return;

                // Get active route assignments
                const { data: assignments, error: assignError } = await window.supabaseClient
                    .from('active_route_assignments')
                    .select('driver_id, route_number, route_name, status')
                    .eq('status', 'active');

                // Create a map of bus_no -> route info
                const routeMap = new Map();
                if (!assignError && Array.isArray(assignments)) {
                    assignments.forEach(a => {
                        if (a.driver_id && a.route_number) {
                            routeMap.set(a.driver_id, {
                                routeNumber: a.route_number,
                                routeName: a.route_name || ''
                            });
                        }
                    });
                }

                const seen = new Set();
                positions.forEach(r => {
                    if (r && r.bus_no != null && r.lat != null && r.lng != null) {
                        seen.add(r.bus_no);
                        const routeInfo = routeMap.get(r.bus_no);
                        upsertBusMarkerAdmin(r.bus_no, r.lat, r.lng, routeInfo);
                    }
                });

                if (_adminBusMarkers) {
                    Array.from(_adminBusMarkers.keys()).forEach(key => {
                        if (!seen.has(key)) {
                            removeBusMarkerAdmin(key);
                        }
                    });
                }

                // Update unified routes table if visible (real-time status)
                const manageSection = document.getElementById('manage-section');
                if (manageSection && !manageSection.classList.contains('hidden')) {
                    loadUnifiedRoutes();
                }
            } catch (_) { }
        }

        function subscribeBusPositionsAdmin() {
            try {
                if (!window.supabaseClient || _busPosChannel) return;
                _busPosChannel = window.supabaseClient
                    .channel('bus_positions_live_admin')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'bus_positions' }, (payload) => {
                        try {
                            // Reload all positions to get updated route assignments
                            loadCurrentBusPositionsAdmin();
                        } catch (_) { }
                    })
                    .subscribe();
            } catch (_) { }
        }

        function initLiveBusesAdmin() {
            try {
                if (!window.supabaseClient || !window._collegeMap) return;
                loadCurrentBusPositionsAdmin();
                if (!_adminBusPollTimer) {
                    _adminBusPollTimer = setInterval(loadCurrentBusPositionsAdmin, 10000);
                }
                subscribeBusPositionsAdmin();
            } catch (_) { }
        }

        // Change Password modal helpers
        function openChangePasswordModal() {
            cpError.classList.add('hidden');
            cpSuccess.classList.add('hidden');
            cpCurrent.value = '';
            cpNew.value = '';
            cpConfirm.value = '';
            changePasswordModal.classList.remove('hidden');
        }
        function closeChangePasswordModal() {
            changePasswordModal.classList.add('hidden');
        }
        function formatDateTime(iso) {
            try {
                const d = new Date(iso);
                return d.toLocaleString('en-IN', { hour12: true });
            } catch (e) { return iso; }
        }

        async function loadLoginLogs() {
            loginLogsTbody.innerHTML = '<tr><td colspan="4" class="py-3 px-6 text-center text-gray-400">Loading login logs...</td></tr>';
            // Prefer Supabase if configured
            if (window.supabaseClient) {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('student_logins')
                        .select('email, student_id, login_at')
                        .order('login_at', { ascending: false });
                    if (!error && Array.isArray(data)) {
                        if (data.length === 0) {
                            loginLogsTbody.innerHTML = `<tr><td colspan="4" class="py-3 px-6 text-center text-gray-400">No login activity yet.</td></tr>`;
                            return;
                        }
                        loginLogsTbody.innerHTML = '';
                        data.forEach((log, idx) => {
                            const tr = document.createElement('tr');
                            tr.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'transition-colors', 'duration-200');
                            tr.innerHTML = `
                                <td class="py-3 px-6">${idx + 1}</td>
                                <td class="py-3 px-6">${log.email || ''}</td>
                                <td class="py-3 px-6">${log.student_id || ''}</td>
                                <td class="py-3 px-6">${formatDateTime(log.login_at)}</td>
                            `;
                            loginLogsTbody.appendChild(tr);
                        });
                        return;
                    }
                } catch (e) { console.error("Error loading logs:", e); }
            }
            loginLogsTbody.innerHTML = `<tr><td colspan="4" class="py-3 px-6 text-center text-red-600">Failed to load logs. Database error.</td></tr>`;
        }

        async function clearLoginLogs() {
            if (window.supabaseClient) {
                try {
                    const { error } = await window.supabaseClient.from('student_logins').delete().neq('student_id', null);
                    if (!error) { loadLoginLogs(); return; }
                } catch (e) { }
            }
            showMessage('Could not clear logs. Supabase connection required.');
        }

        async function logoutAdmin() {
            try { hideStopsModal(); } catch (e) { }
            try {
                // Supabase Sign Out
                if (window.supabaseClient) { await window.supabaseClient.auth.signOut(); }
                // Clear any local auth remnants
                localStorage.removeItem(ADMIN_STORAGE.adminAuth);
            } catch (e) { try { console.error('Supabase signOut error', e); } catch (_) { } }
            window.location.href = 'admin-login.html';
        }

        /**
         * Populates the bus schedule table based on the selected date.
         */
        function formatTimeDisplay(hhmm) {
            try {
                if (!hhmm) return '';
                const [h, m] = hhmm.split(':');
                let hour = parseInt(h, 10);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12; if (hour === 0) hour = 12;
                return `${hour.toString().padStart(1, '0')}:${(m || '00').padStart(2, '0')} ${ampm}`;
            } catch { return hhmm; }
        }

        // Convert 12h input + AM/PM to 24h HH:MM
        function to24h(hhmm, ampm) {
            try {
                if (!hhmm) return '';
                let [h, m] = hhmm.split(':');
                let hour = parseInt(h, 10);
                if (isNaN(hour)) return hhmm;
                hour = hour % 12; // 12 -> 0 base before AM/PM add
                if ((ampm || 'AM').toUpperCase() === 'PM') hour += 12;
                return `${hour.toString().padStart(2, '0')}:${(m || '00').padStart(2, '0')}`;
            } catch { return hhmm; }
        }

        // For a stored 24h HH:MM, return AM/PM and also a 12h display hour if needed
        function getAmPmFrom24h(hhmm) {
            try {
                if (!hhmm) return 'AM';
                const [h] = hhmm.split(':');
                const hour = parseInt(h, 10);
                return hour >= 12 ? 'PM' : 'AM';
            } catch { return 'AM'; }
        }

        // For a 24h HH:MM, return 12h HH:MM (no AM/PM label)
        function to12hNoAmPm(hhmm) {
            try {
                if (!hhmm) return '';
                const [h, m] = hhmm.split(':');
                let hour = parseInt(h, 10);
                if (isNaN(hour)) return hhmm;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12; if (hour === 0) hour = 12;
                return `${hour.toString().padStart(2, '0')}:${(m || '00').padStart(2, '0')}`;
            } catch { return hhmm; }
        }

        function populateScheduleTable(selectedDate) {
            scheduleTableBody.innerHTML = '';
            const dayOfWeek = daysOfWeek[selectedDate.getDay()];

            // Only use addedRoutesData (now populated from DB)
            const allBusData = [...addedRoutesData];

            if (allBusData.length === 0) {
                scheduleTableBody.innerHTML = `<tr><td colspan="4" class="py-3 px-6 text-center text-gray-400">No schedules available for this day.</td></tr>`;
                return;
            }

            allBusData.forEach(bus => {
                const schedule = bus.schedule[dayOfWeek];
                if (schedule) {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'transition-colors', 'duration-200', 'cursor-pointer');
                    row.setAttribute('data-bus-no', bus.busNo);
                    row.setAttribute('data-is-added', bus.isUserAdded ? 'true' : 'false');
                    row.innerHTML = `
                        <td class="py-3 px-6">${bus.busNo}</td>
                        <td class="py-3 px-6">${bus.route}</td>
                        <td class="py-3 px-6 schedule-time-cell">${formatTimeDisplay(schedule.departureTime)}</td>
                        <td class="py-3 px-6 schedule-time-cell">${formatTimeDisplay(schedule.eta)}</td>
                    `;
                    scheduleTableBody.appendChild(row);
                }
            });
        }

        /**
     * Populates the table with user-added routes.
     */
        function populateUserRoutesTable() {
            if (!userRoutesTableBody) {
                console.warn('userRoutesTableBody element not found');
                return;
            }

            userRoutesTableBody.innerHTML = '';

            if (addedRoutesData.length === 0) {
                userRoutesTableBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-gray-400">No routes added yet.</td></tr>`;
                return;
            }

            addedRoutesData.forEach((route, index) => {
                const stopsHTML = route.stops.map(stop => `${stop.name} (${formatTimeDisplay(stop.time)})`).join('<br>');
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'transition-colors', 'duration-200');

                // Get first stop time as departure and last stop time as ETA (from stops array)
                const departureTime = route.stops[0] ? route.stops[0].time : 'N/A';
                const etaTime = route.stops[route.stops.length - 1] ? route.stops[route.stops.length - 1].time : 'N/A';

                row.innerHTML = `
                    <td class="py-3 px-6">${route.busNo}</td>
                    <td class="py-3 px-6">${route.route}</td>
                    <td class="py-3 px-6">${formatTimeDisplay(departureTime)}</td>
                    <td class="py-3 px-6">${formatTimeDisplay(etaTime)}</td>
                    <td class="py-3 px-6 text-sm">${stopsHTML}</td>
                    <td class="py-3 px-6 space-x-2">
                        <button class="edit-btn bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded text-xs" data-index="${index}">Edit</button>
                        <button class="remove-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs" data-index="${index}" data-bus-no="${route.busNo}">Remove</button>
                    </td>
                `;
                if (userRoutesTableBody) {
                    userRoutesTableBody.appendChild(row);
                } else {
                    console.warn('userRoutesTableBody element not found during append');
                }
            });

            // Add event listeners to new remove buttons
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.getAttribute('data-index');
                    const busNo = e.target.getAttribute('data-bus-no');
                    removeBusRoute(index, busNo);
                });
            });

            // Add event listeners to new edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.getAttribute('data-index');
                    editBusRoute(index);
                });
            });
        }

        /**
         * Removes a bus route by index.
         * @param {number} index The index of the route to remove.
         */
        async function removeBusRoute(index, busNo) {
            if (!busNo) return;
            if (!window.supabaseClient) { showMessage('Supabase connection required to remove routes.'); return; }

            showLoading();
            try {
                // First attempt: direct delete (works if FK has ON DELETE CASCADE)
                const { error: delErr } = await window.supabaseClient
                    .from('bus_routes')
                    .delete()
                    .eq('route_number', busNo);

                if (delErr) {
                    // Fallback: manually delete dependent stops, then the route
                    // 1) Find route id by route_number
                    const { data: routeRows, error: selErr } = await window.supabaseClient
                        .from('bus_routes')
                        .select('id')
                        .eq('route_number', busNo)
                        .limit(1);
                    if (selErr) throw selErr;
                    const routeId = Array.isArray(routeRows) && routeRows.length ? routeRows[0].id : null;
                    if (!routeId) throw delErr; // nothing to delete or unexpected error

                    // 2) Delete dependent route_stops
                    const { error: stopDelErr } = await window.supabaseClient
                        .from('route_stops')
                        .delete()
                        .eq('route_id', routeId);
                    if (stopDelErr) throw stopDelErr;

                    // 3) Delete the route by id
                    const { error: routeDelErr } = await window.supabaseClient
                        .from('bus_routes')
                        .delete()
                        .eq('id', routeId);
                    if (routeDelErr) throw routeDelErr;
                }

                // Update local state and UI
                addedRoutesData.splice(index, 1);
                populateUserRoutesTable();
                const dateForTable = scheduleDateInput.value ? new Date(scheduleDateInput.value) : new Date();
                populateScheduleTable(dateForTable);
                showMessage('Bus route removed successfully.');

            } catch (e) {
                console.error('DB delete error', e);
                const msg = (e && (e.details || e.message)) || 'Database Error';
                showMessage(`Failed to remove route in database: ${msg}.`);
            } finally {
                hideLoading();
            }
        }

        /**
         * Edits a bus route by index.
         * @param {number} index The index of the route to edit.
         */
        function editBusRoute(index) {
            const busToEdit = addedRoutesData[index];
            if (!busToEdit) {
                return;
            }

            isEditing = true;
            editingIndex = index;
            submitBtn.textContent = 'Save Changes';
            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

            busNumberInput.value = busToEdit.busNo;
            routeNameInput.value = busToEdit.route;

            // Populate departure/eta from the first/last stop in the route, using the stop data
            const departureTime = busToEdit.stops[0] ? busToEdit.stops[0].time : '00:00';
            const etaTime = busToEdit.stops[busToEdit.stops.length - 1] ? busToEdit.stops[busToEdit.stops.length - 1].time : '00:00';

            // Populate form fields with 24h time strings (HH:MM)
            departureTimeInput.value = departureTime;
            etaInput.value = etaTime;

            // Rebuild stops builder
            if (stopsBuilder) { stopsBuilder.innerHTML = ''; }
            busToEdit.stops.forEach(s => addStopRow(s.name || '', s.time || ''));
            updateStopsTextarea();
        }

        /**
         * Updates the current time displayed on the page.
         */
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            currentTimeEl.textContent = now.toLocaleDateString('en-IN', options);
        }

        // --- Dashboard Stats ---
        function getTodayScheduleCount() {
            try {
                const today = new Date();
                const dayOfWeek = daysOfWeek[today.getDay()];
                const allBusData = [...addedRoutesData];
                let count = 0;
                allBusData.forEach(b => { if (b && b.schedule && b.schedule[dayOfWeek]) count++; });
                return count;
            } catch (_) { return 0; }
        }

        async function refreshDashboardStats() {
            // Active buses from Supabase bus_positions (unique bus_no)
            let active = 0;
            // On-time departures computed using scheduled departure for today vs recent position timestamps
            let onTime = 0;
            const allBusData = [...busScheduleData, ...addedRoutesData];

            // Helper: parse schedule time string (supports 'HH:MM' 24h or 'HH:MM AM/PM') into a Date today
            function parseScheduleTimeToDate(timeStr) {
                try {
                    if (!timeStr) return null;
                    const now = new Date();
                    const yyyy = now.getFullYear();
                    const mm = now.getMonth();
                    const dd = now.getDate();
                    let h = 0, m = 0;
                    const ampmMatch = /\s*(AM|PM)\s*$/i.exec(timeStr);
                    if (ampmMatch) {
                        const [hh, mi] = timeStr.replace(/\s*(AM|PM)\s*$/i, '').split(':');
                        h = parseInt(hh, 10) || 0; m = parseInt(mi, 10) || 0;
                        const isPM = ampmMatch[1].toUpperCase() === 'PM';
                        h = h % 12 + (isPM ? 12 : 0);
                    } else {
                        const [hh, mi] = timeStr.split(':');
                        h = parseInt(hh, 10) || 0; m = parseInt(mi, 10) || 0;
                    }
                    return new Date(yyyy, mm, dd, h, m, 0, 0);
                } catch (_) { return null; }
            }

            // Fetch positions once (bus_no, updated_at)
            let positions = [];
            if (window.supabaseClient) {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('bus_positions')
                        .select('bus_no, updated_at');
                    if (!error && Array.isArray(data)) positions = data;
                } catch (_) { }
            }

            // Active = unique bus_no present
            try { const s = new Set(); positions.forEach(r => r && r.bus_no && s.add(r.bus_no)); active = s.size; } catch (_) { }
            try { if (activeBusesCountEl) activeBusesCountEl.textContent = String(active); } catch (_) { }

            // On-time calculation: for each bus with today's schedule, if there's a position updated within
            // [depTime - 5 min, depTime + 10 min], consider it on-time.
            try {
                const dayOfWeek = daysOfWeek[new Date().getDay()];
                const byBusNo = new Map(); positions.forEach(p => { if (p && p.bus_no) byBusNo.set(p.bus_no, p); });
                const windowBeforeMs = 5 * 60 * 1000;  // 5 minutes before
                const windowAfterMs = 10 * 60 * 1000; // 10 minutes after
                onTime = 0;
                allBusData.forEach(b => {
                    try {
                        if (!b || !b.busNo || !b.schedule || !b.schedule[dayOfWeek]) return;
                        const sched = b.schedule[dayOfWeek];
                        const dep = parseScheduleTimeToDate(sched.departureTime);
                        if (!dep) return;
                        const pos = byBusNo.get(b.busNo);
                        if (!pos || !pos.updated_at) return;
                        const upd = new Date(pos.updated_at);
                        const diff = upd.getTime() - dep.getTime();
                        if (diff >= -windowBeforeMs && diff <= windowAfterMs) onTime++;
                    } catch (_) { }
                });
            } catch (_) { onTime = 0; }
            try { if (onTimeCountEl) onTimeCountEl.textContent = String(onTime); } catch (_) { }

            // Trips Today (Total scheduled for today)
            try {
                const count = getTodayScheduleCount();
                if (tripsTodayCountEl) tripsTodayCountEl.textContent = String(count);
            } catch (_) { }
        }

        /**
         * Displays a custom message box.
         * @param {string} message The message to display.
         */
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function loadEmergencyLastSeen() {
            try {
                const stored = localStorage.getItem(EMERGENCY_LAST_SEEN_KEY);
                return stored ? new Date(stored) : null;
            } catch (_) {
                return null;
            }
        }

        function saveEmergencyLastSeen(ts) {
            try {
                localStorage.setItem(EMERGENCY_LAST_SEEN_KEY, ts instanceof Date ? ts.toISOString() : (ts || ''));
            } catch (_) { }
        }

        function markEmergencyAlertsSeen(latestTimestamp) {
            saveEmergencyLastSeen(latestTimestamp || new Date());
            emergencyLastSeen = loadEmergencyLastSeen();
            if (emergencyAlertBadge) emergencyAlertBadge.classList.add('hidden');
            if (emergencyAlertHeaderBadge) emergencyAlertHeaderBadge.classList.add('hidden');
            if (emergencyAlertsList) emergencyAlertsList.classList.remove('notes-blink');
        }

        function renderEmergencyAlerts() {
            if (!emergencyAlertsList) return;
            emergencyAlertsList.innerHTML = '';

            if (!emergencyAlerts || emergencyAlerts.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'text-gray-500';
                empty.textContent = 'No emergency alerts yet.';
                emergencyAlertsList.appendChild(empty);
                if (emergencyAlertCount) emergencyAlertCount.textContent = '0';
                return;
            }

            const fragment = document.createDocumentFragment();
            const lastSeenTime = emergencyLastSeen ? emergencyLastSeen.getTime() : 0;
            let hasUnseen = false;

            emergencyAlerts.forEach((alert) => {
                const card = document.createElement('div');
                card.className = 'border border-red-200 rounded-lg p-3 bg-red-50';

                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-2';

                const title = document.createElement('h4');
                title.className = 'font-semibold text-red-700';
                title.textContent = alert.title || 'Emergency Alert';

                const time = document.createElement('span');
                time.className = 'text-xs text-red-600';
                time.textContent = formatDateTime(alert.created_at);

                header.appendChild(title);
                header.appendChild(time);

                const body = document.createElement('p');
                body.className = 'text-sm text-gray-700';
                body.textContent = alert.message || alert.description || 'No details provided.';

                const meta = document.createElement('div');
                meta.className = 'mt-2 text-xs text-gray-500 space-y-1';
                if (alert.reported_by_type || alert.reported_by_id) {
                    const reporter = document.createElement('div');
                    reporter.textContent = `Reported by: ${alert.reported_by_type || 'unknown'}${alert.reported_by_id ? ` (${alert.reported_by_id})` : ''}`;
                    meta.appendChild(reporter);
                }
                if (alert.incident_type) {
                    const type = document.createElement('div');
                    type.textContent = `Type: ${alert.incident_type}`;
                    meta.appendChild(type);
                }
                if (alert.severity) {
                    const severity = document.createElement('div');
                    severity.textContent = `Severity: ${alert.severity}`;
                    meta.appendChild(severity);
                }
                if (alert.bus_no) {
                    const bus = document.createElement('div');
                    bus.textContent = `Bus: ${alert.bus_no}`;
                    meta.appendChild(bus);
                }
                if (alert.location_lat != null && alert.location_lng != null) {
                    const loc = document.createElement('div');
                    loc.textContent = `Location: ${Number(alert.location_lat).toFixed(5)}, ${Number(alert.location_lng).toFixed(5)}`;
                    meta.appendChild(loc);
                }
                if (alert.status) {
                    const status = document.createElement('div');
                    status.textContent = `Status: ${alert.status}`;
                    meta.appendChild(status);
                }

                card.appendChild(header);
                card.appendChild(body);
                if (meta.childElementCount) card.appendChild(meta);

                const createdTime = alert.created_at ? new Date(alert.created_at).getTime() : 0;
                if (createdTime > lastSeenTime) {
                    card.classList.add('notes-blink');
                    hasUnseen = true;
                }

                fragment.appendChild(card);
            });

            emergencyAlertsList.appendChild(fragment);
            if (emergencyAlertCount) emergencyAlertCount.textContent = String(emergencyAlerts.length);

            if (hasUnseen) {
                if (emergencyAlertBadge) emergencyAlertBadge.classList.remove('hidden');
                if (emergencyAlertHeaderBadge) emergencyAlertHeaderBadge.classList.remove('hidden');
                if (emergencyAlertsList) emergencyAlertsList.classList.add('notes-blink');
            } else {
                if (emergencyAlertBadge) emergencyAlertBadge.classList.add('hidden');
                if (emergencyAlertHeaderBadge) emergencyAlertHeaderBadge.classList.add('hidden');
                if (emergencyAlertsList) emergencyAlertsList.classList.remove('notes-blink');
            }
        }

        // --- Admin Notes: Edit/Save wired to Supabase ---
        function setNotesEditing(state) {
            isNotesEditing = !!state;
            try { if (adminNotesDisplay) adminNotesDisplay.classList.toggle('hidden', isNotesEditing); } catch (_) { }
            try { if (adminNotesTextarea) adminNotesTextarea.classList.toggle('hidden', !isNotesEditing); } catch (_) { }
            try { if (saveNotesBtn) saveNotesBtn.classList.toggle('hidden', !isNotesEditing); } catch (_) { }
            try { if (editNotesBtn) editNotesBtn.classList.toggle('hidden', isNotesEditing); } catch (_) { }
            if (isNotesEditing && adminNotesTextarea) {
                try { adminNotesTextarea.focus(); adminNotesTextarea.setSelectionRange(adminNotesTextarea.value.length, adminNotesTextarea.value.length); } catch (_) { }
            }
        }

        if (editNotesBtn) {
            editNotesBtn.addEventListener('click', () => {
                try { adminNotesTextarea.value = (adminNotesDisplay?.textContent || '').trim(); } catch (_) { }
                setNotesEditing(true);
            });
        }

        if (saveNotesBtn) {
            saveNotesBtn.addEventListener('click', async () => {
                const content = (adminNotesTextarea?.value || '').trim();
                if (!content) { showMessage('Please enter a note before saving.'); return; }
                if (!window.supabaseClient) { showMessage('Supabase is not configured.'); return; }
                try {
                    const ok = await ensureSupabaseAdminAuth();
                    if (!ok) { showMessage('Please sign in as an authorized admin to save notes.'); return; }
                    const { error } = await window.supabaseClient
                        .from('admin_notes')
                        .insert([{ title: 'Special Notice', content }]);
                    if (error) throw error;
                    try { if (adminNotesDisplay) adminNotesDisplay.textContent = content; } catch (_) { }
                    try { localStorage.setItem('vt_admin_notes', content); } catch (_) { }
                    setNotesEditing(false);
                    showMessage('Admin note saved successfully.');
                } catch (e) {
                    const msg = (e && (e.details || e.message)) || 'Failed to save note.';
                    showMessage(msg);
                }
            });
        }

        /**
         * Displays the modal with bus stops in a table.
         * @param {string} busNo The bus number to show stops for.
         * @param {boolean} isUserAdded True if the bus is user-added, false otherwise.
         */
        function showStops(busNo, isUserAdded) {
            let bus = null;

            // First try to find in local data
            if (isUserAdded) {
                bus = addedRoutesData.find(b => b.busNo === busNo);
            } else {
                bus = busScheduleData.find(b => b.busNo === busNo);
            }

            // If found locally and has stops, display immediately
            if (bus && bus.stops && bus.stops.length > 0) {
                displayStopsModal(busNo, bus.stops);
                return;
            }

            // If not found locally or no stops, try to fetch from database
            if (window.supabaseClient) {
                loadStopsFromDatabase(busNo);
            } else {
                showMessage('No stops data available for this route');
            }
        }

        async function loadStopsFromDatabase(busNo) {
            try {
                // Try to get from bus_routes table first
                const { data: routeData, error: routeError } = await window.supabaseClient
                    .from('bus_routes')
                    .select('stops')
                    .eq('route_number', busNo)
                    .single();

                if (!routeError && routeData && routeData.stops) {
                    displayStopsModal(busNo, routeData.stops);
                    return;
                }

                // Try to get from route_stops table with proper filtering
                const { data: stopsData, error: stopsError } = await window.supabaseClient
                    .from('route_stops')
                    .select(`
                        stop_id,
                        sequence_order,
                        estimated_arrival_time,
                        bus_stops (
                            stop_name,
                            location
                        )
                    `)
                    .eq('route_id', busNo)
                    .order('sequence_order');

                if (!stopsError && stopsData && stopsData.length > 0) {
                    // Convert to expected format - only stops for this specific route
                    const stops = stopsData.map(stop => ({
                        name: stop.bus_stops?.stop_name || `Stop ${stop.stop_id}`,
                        time: stop.estimated_arrival_time,
                        location: stop.bus_stops?.location || 'Unknown'
                    }));
                    displayStopsModal(busNo, stops);
                    return;
                }

                // If no route-specific stops found, show message
                showMessage('No stops found for this specific route');

            } catch (e) {
                console.error('Error loading stops from database:', e);
                showMessage('Error loading stops for this route');
            }
        }

        function displayStopsModal(busNo, stops) {
            stopsModalTitle.textContent = `Stops for Bus ${busNo}`;
            stopsTableBody.innerHTML = ''; // Clear previous data

            if (stops.length === 0) {
                stopsTableBody.innerHTML = '<tr><td colspan="2" class="py-3 px-6 text-center text-gray-400">No stops found</td></tr>';
            } else {
                stops.forEach((stop, index) => {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'transition-colors', 'duration-200');
                    row.innerHTML = `
                        <td class="py-3 px-6">
                            <div class="font-medium">${stop.name || stop}</div>
                            ${stop.location ? `<div class="text-xs text-gray-500">${stop.location}</div>` : ''}
                        </td>
                        <td class="py-3 px-6">${formatTimeDisplay(stop.time || stop.eta || stop.estimated_arrival_time)}</td>
                    `;
                    stopsTableBody.appendChild(row);
                });
            }
            stopsModal.classList.remove('hidden');
        }

        /**
         * Hides the stops modal.
         */
        function hideStopsModal() {
            if (stopsModal) {
                stopsModal.classList.add('hidden');
            }
        }
        // Allow closing the stops modal with Escape key (global listener)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                try {
                    if (!stopsModal || stopsModal.classList.contains('hidden')) return;
                    hideStopsModal();
                } catch (_) { }
            }
        });

        /**
         * Parses the stops data from the textarea input.
         * @param {string} stopsString The string from the stops-data textarea.
         * @returns {Array<Object>} An array of stop objects.
         */
        function parseStops(stopsString) {
            const stops = [];
            const stopsArray = stopsString.split(';').map(s => s.trim()).filter(s => s.length > 0);
            stopsArray.forEach(stopStr => {
                const parts = stopStr.split(',').map(p => p.trim());
                if (parts.length === 2) {
                    // Store time in 24h format for internal consistency
                    const time24h = parts[1].toUpperCase().includes('A') || parts[1].toUpperCase().includes('P') ? parts[1].replace(/\s*(AM|PM)\s*$/i, '').trim() : parts[1];
                    stops.push({ name: parts[0], time: time24h });
                }
            });
            return stops;
        }

        // --- Stops Builder UI ---
        function updateStopsTextarea() {
            try {
                const rows = stopsBuilder ? Array.from(stopsBuilder.querySelectorAll('.stop-row')) : [];
                const parts = [];
                rows.forEach(row => {
                    const name = row.querySelector('.stop-name')?.value?.trim() || '';
                    const time12 = row.querySelector('.stop-time')?.value?.trim() || '';
                    const ampmSel = row.querySelector('.stop-ampm');
                    const ampm = ampmSel ? (ampmSel.value || 'AM') : 'AM';
                    const time24 = to24h(time12, ampm);
                    if (name && time24) { parts.push(`${name},${time24}`); }
                });
                if (stopsDataTextarea) { stopsDataTextarea.value = parts.join('; '); }
                // Keep top-level departure/ETA inputs in sync with first/last stop times unless suppressed
                if (!suppressTopLevelSync) {
                    try { syncDepartureEtaWithStops(); } catch (_) { }
                }
            } catch (_) { }
        }

        // Keep departure/ETA inputs synced with the first and last stop times
        function syncDepartureEtaWithStops() {
            if (!stopsBuilder) return;
            const rows = Array.from(stopsBuilder.querySelectorAll('.stop-row'));
            if (rows.length === 0) return;
            const firstRowTime = rows[0].querySelector('.stop-time')?.value?.slice(0, 5) || '';
            const firstRowAmPm = rows[0].querySelector('.stop-ampm')?.value || 'AM';
            const lastRowTime = rows[rows.length - 1].querySelector('.stop-time')?.value?.slice(0, 5) || '';
            const lastRowAmPm = rows[rows.length - 1].querySelector('.stop-ampm')?.value || 'AM';
            if (departureTimeInput && firstRowTime) {
                departureTimeInput.value = firstRowTime;
            }
            if (departureAmPm && firstRowAmPm) {
                departureAmPm.value = firstRowAmPm;
            }
            if (etaInput && lastRowTime) {
                etaInput.value = lastRowTime;
            }
            if (etaAmPm && lastRowAmPm) {
                etaAmPm.value = lastRowAmPm;
            }
        }

        function addStopRow(name = '', time = '') {
            if (!stopsBuilder) return;
            const row = document.createElement('div');
            row.className = 'stop-row flex items-center gap-2';
            // Convert incoming time (assumed 24h HH:MM) to 12h input + AM/PM select
            const t24 = (time || '').slice(0, 5);
            const t12 = to12hNoAmPm(t24);
            const ampm = getAmPmFrom24h(t24);
            row.innerHTML = `
                <input type="text" class="stop-name flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Stop name" value="${name.replace(/"/g, '&quot;')}">
                <button type="button" class="insert-stop-before px-2 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700" title="Insert stop before">+</button>
                <input type="time" class="stop-time w-28 px-2 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${t12}">
                <select class="stop-ampm w-20 px-2 py-2 border border-gray-300 rounded-md bg-white text-sm">
                    <option value="AM" ${ampm === 'AM' ? 'selected' : ''}>AM</option>
                    <option value="PM" ${ampm === 'PM' ? 'selected' : ''}>PM</option>
                </select>
                <button type="button" class="remove-stop px-2 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700">‚úï</button>
            `;
            stopsBuilder.appendChild(row);
            const onChange = () => updateStopsTextarea();
            row.querySelector('.stop-name').addEventListener('input', onChange);
            row.querySelector('.stop-time').addEventListener('input', onChange);
            row.querySelector('.stop-ampm').addEventListener('change', onChange);
            row.querySelector('.stop-ampm').addEventListener('input', onChange);

            // Insert stop before current stop
            row.querySelector('.insert-stop-before').addEventListener('click', () => {
                const newRow = document.createElement('div');
                newRow.className = 'stop-row flex items-center gap-2';
                newRow.innerHTML = `
                    <input type="text" class="stop-name flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Stop name" value="">
                    <button type="button" class="insert-stop-before px-2 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700" title="Insert stop before">+</button>
                    <input type="time" class="stop-time w-28 px-2 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="">
                    <select class="stop-ampm w-20 px-2 py-2 border border-gray-300 rounded-md bg-white text-sm">
                        <option value="AM" selected>AM</option>
                        <option value="PM">PM</option>
                    </select>
                    <button type="button" class="remove-stop px-2 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700">‚úï</button>
                `;
                stopsBuilder.insertBefore(newRow, row);

                // Add event listeners to new row
                const onChangeNew = () => updateStopsTextarea();
                newRow.querySelector('.stop-name').addEventListener('input', onChangeNew);
                newRow.querySelector('.stop-time').addEventListener('input', onChangeNew);
                newRow.querySelector('.stop-ampm').addEventListener('change', onChangeNew);
                newRow.querySelector('.stop-ampm').addEventListener('input', onChangeNew);
                newRow.querySelector('.remove-stop').addEventListener('click', () => {
                    newRow.remove();
                    updateStopsTextarea();
                });
                newRow.querySelector('.insert-stop-before').addEventListener('click', () => {
                    const newerRow = document.createElement('div');
                    newerRow.className = 'stop-row flex items-center gap-2';
                    newerRow.innerHTML = newRow.innerHTML;
                    stopsBuilder.insertBefore(newerRow, newRow);
                    // ... (same event listener setup)
                    updateStopsTextarea();
                });
                updateStopsTextarea();
            });

            row.querySelector('.remove-stop').addEventListener('click', () => {
                row.remove();
                updateStopsTextarea();
            });
            updateStopsTextarea();
        }

        function rebuildStopsBuilderFromTextarea() {
            if (!stopsBuilder) return;
            stopsBuilder.innerHTML = '';
            const stops = parseStops(stopsDataTextarea?.value || '');
            if (stops.length === 0) {
                addStopRow('', '');
            } else {
                stops.forEach(s => addStopRow(s.name || '', (s.time || '').slice(0, 5)));
            }
            updateStopsTextarea();
        }

        // Initialize builder
        if (addStopBtn) {
            addStopBtn.addEventListener('click', () => addStopRow('', ''));
        }

        // AI Route Optimization
        const aiOptimizeBtn = document.getElementById('ai-optimize-btn');
        if (aiOptimizeBtn) {
            aiOptimizeBtn.addEventListener('click', optimizeRouteWithAI);
        }

        // Route Map Toggle

        if (stopsBuilder) {
            if (!stopsBuilder.childElementCount) { addStopRow('', ''); }
            updateStopsTextarea();
        }

        /**
         * Initializes the admin notes display.
         */
        async function initializeAdminNotes() {
            // Supabase-only load of latest note
            adminNotes = 'Loading notes...';
            if (window.supabaseClient) {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('admin_notes')
                        .select('content, updated_at')
                        .order('updated_at', { ascending: false })
                        .limit(1);
                    if (!error && Array.isArray(data) && data.length > 0) {
                        adminNotes = data[0].content || '';
                    } else {
                        adminNotes = "Welcome Admin! Use this panel to post important messages for students.";
                    }
                } catch (e) { adminNotes = "Welcome Admin! Use this panel to post important messages for students."; }
            }
            adminNotesDisplay.textContent = adminNotes;
        }

        async function loadRoutes() {
            // Supabase-only load of routes and stops
            addedRoutesData = [];
            if (!window.supabaseClient) return;
            try {
                // Load all routes from database
                const { data, error } = await window.supabaseClient
                    .from('bus_routes')
                    .select('id, route_number, route_name, route_stops(sequence_order, estimated_arrival_time, bus_stops(stop_name))')
                    .order('route_number');

                if (error) {
                    console.error('loadRoutes error:', error);
                    return [];
                }

                if (!Array.isArray(data)) {
                    console.warn('No routes found in database');
                    return [];
                }

                // Filter out invalid route numbers and warn user
                const validRoutes = data.filter(route => {
                    const isValidFormat = route.route_number && route.route_number.match(/^[A-Z0-9]{3,6}$/);
                    if (!isValidFormat) {
                        console.warn(`Invalid route number format found: ${route.route_number}`);
                        return false;
                    }
                    return true;
                });

                const invalidRoutes = data.filter(route => !route.route_number || !route.route_number.match(/^[A-Z0-9]{3,6}$/));
                if (invalidRoutes.length > 0) {
                    console.warn(`Found ${invalidRoutes.length} routes with invalid numbers:`, invalidRoutes.map(r => r.route_number));
                    showMessage(`‚ö†Ô∏è Found ${invalidRoutes.length} routes with invalid bus numbers. Please contact administrator to fix database data.`);
                }

                return validRoutes.map(r => {
                    const stopsArr = (r.route_stops || []).sort((a, b) => a.sequence_order - b.sequence_order);
                    const stops = stopsArr.map(s => ({ name: (s.bus_stops && s.bus_stops.stop_name) || '', time: (s.estimated_arrival_time || '').toString().slice(0, 5) }));
                    const dep = stopsArr.length ? (stopsArr[0].estimated_arrival_time || '').toString().slice(0, 5) : '';
                    const arr = stopsArr.length ? (stopsArr[stopsArr.length - 1].estimated_arrival_time || '').toString().slice(0, 5) : '';
                    const sched = {};
                    daysOfWeek.forEach(d => { sched[d] = { departureTime: dep, eta: arr }; });
                    return { id: r.id, busNo: r.route_number, route: r.route_name, schedule: sched, stops, isUserAdded: true };
                });
            } catch (e) {
                console.error('loadRoutes DB error', e);
                return [];
            }
        }

        function persistRoutes() { /* Supabase-only mode: no localStorage persistence */ }

        async function syncRouteToDB(route) {
            if (!window.supabaseClient) { window._lastRouteSyncError = 'Supabase client not initialized'; return false; }
            const payload = { route_json: route };
            let lastErr = null;
            let authedOnce = false;
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    // Proceed with sync
                    const { data, error } = await window.supabaseClient.rpc('sync_route', {
                        route_json: payload.route_json  // Correct parameter name
                    });
                    if (error) throw error;
                    window._lastRouteSyncError = '';
                    return true;
                } catch (e) {
                    lastErr = e;
                    const msg = (e && (e.message || e.details || '')) || '';
                    const needsAuth = /not allowed|permission|jwt|auth|unauth/i.test(msg);
                    if (needsAuth && !authedOnce) {
                        const ok = await ensureSupabaseAdminAuth();
                        authedOnce = true;
                        if (ok) { continue; }
                    }
                    await new Promise(r => setTimeout(r, 300 * attempt));
                }
            }
            window._lastRouteSyncError = (lastErr && (lastErr.message || String(lastErr))) || 'Unknown error';
            return false;
        }

        async function ensureSupabaseAdminAuth() {
            try {
                const supa = window.supabaseClient;
                if (!supa) return false;
                let { data: userData } = await supa.auth.getUser();
                let uid = userData && userData.user && userData.user.id ? userData.user.id : null;
                if (uid && (!ADMIN_ALLOWED_UID || uid === ADMIN_ALLOWED_UID)) return true;

                // Check if already authenticated via sessionStorage
                const isAuthenticated = sessionStorage.getItem('admin_authenticated') === 'true';
                if (isAuthenticated) return true;

                // Show authentication modal instead of prompts
                showAdminAuthModal();
                return false;
            } catch (_) { return false; }
        }


        /**
         * Generates and displays the clickable weekly date buttons.
         */
        function generateWeeklyDates() {
            weeklyDatesContainer.innerHTML = '';
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday...

            // Start from Monday of the current week
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

            // Generate buttons for Monday to Saturday
            for (let i = 0; i < 6; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);

                const dayName = daysOfWeek[date.getDay()].substring(0, 3);
                const dateNum = date.getDate();
                const month = date.toLocaleString('default', { month: 'short' });
                const fullDate = date.toISOString().split('T')[0];

                const button = document.createElement('button');
                button.classList.add('px-3', 'py-2', 'font-medium', 'text-gray-600', 'rounded-lg', 'hover:bg-gray-200', 'focus:outline-none', 'focus:bg-gray-200', 'transition-colors', 'duration-200', 'flex', 'flex-col', 'items-center', 'border', 'border-gray-300');
                if (fullDate === today.toISOString().split('T')[0]) {
                    button.classList.add('bg-gray-200');
                }
                button.dataset.date = fullDate;
                button.innerHTML = `
                    <span class="text-xs">${dayName}</span>
                    <span class="text-sm font-bold">${dateNum}</span>
                    <span class="text-xs">${month}</span>
                `;
                weeklyDatesContainer.appendChild(button);
            }

            // Add event listeners to the newly created buttons
            weeklyDatesContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Remove active state from all buttons
                    weeklyDatesContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-gray-200'));
                    // Add active state to the clicked button
                    e.currentTarget.classList.add('bg-gray-200');
                    const selectedDate = new Date(e.currentTarget.dataset.date);
                    populateScheduleTable(selectedDate);
                });
            });
        }


        // --- Admin Notes Management ---
        async function saveAdminNote() {
            if (!window.supabaseClient) {
                showMessage('Database connection required');
                return;
            }

            const title = document.getElementById('admin-notes-textarea')?.value || 'Admin Notice';
            const content = document.getElementById('admin-notes-textarea')?.value;
            const priority = 'medium'; // Default priority
            const category = 'general'; // Default category
            const isImportant = false; // Default important status

            if (!content) {
                showMessage('Please provide content for the admin note');
                return;
            }

            try {
                const { error } = await window.supabaseClient.rpc('save_admin_note', {
                    p_title: title,
                    p_content: content,
                    p_priority: priority,
                    p_category: category,
                    p_is_important: isImportant
                });

                if (error) {
                    showMessage(`Failed to save admin note: ${error.message}`);
                } else {
                    showMessage('‚úÖ Admin note saved successfully!');
                    // Clear form
                    document.getElementById('admin-notes-textarea').value = '';

                    // Reload admin notes if the function exists
                    if (typeof loadAdminNotes === 'function') {
                        loadAdminNotes();
                    }
                }
            } catch (e) {
                showMessage(`Error saving admin note: ${e.message}`);
            }
        }

        // Load admin notes from database
        async function loadAdminNotes() {
            if (!window.supabaseClient) {
                if (adminNotesDisplay) {
                    adminNotesDisplay.textContent = 'Database connection required';
                }
                return;
            }

            try {
                const { data, error } = await window.supabaseClient
                    .from('admin_notes')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('Error loading admin notes:', error);
                    if (adminNotesDisplay) {
                        adminNotesDisplay.textContent = 'Error loading notes';
                    }
                } else if (data && data.length > 0) {
                    if (adminNotesDisplay) {
                        adminNotesDisplay.innerHTML = data.map(note => `
                            <div class="mb-3 p-3 bg-gray-50 rounded border">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="font-medium text-gray-800">${note.title}</h4>
                                    <span class="text-xs text-gray-500">${new Date(note.updated_at).toLocaleString()}</span>
                                </div>
                                <p class="text-sm text-gray-600">${note.content}</p>
                                ${note.is_important ? '<span class="inline-block px-2 py-1 text-xs bg-red-100 text-red-800 rounded">Important</span>' : ''}
                            </div>
                        `).join('');
                    }
                } else {
                    if (adminNotesDisplay) {
                        adminNotesDisplay.innerHTML = '<p class="text-gray-500">No admin notes found</p>';
                    }
                }
            } catch (e) {
                console.error('Error in loadAdminNotes:', e);
                if (adminNotesDisplay) {
                    adminNotesDisplay.textContent = 'Error loading notes';
                }
            }
        }

        // --- Unified Routes Management Functions ---
        // Load unified routes and driver status
        async function loadUnifiedRoutes() {
            if (!window.supabaseClient) return;

            try {
                // Load all routes
                const { data: routes, error: routesError } = await window.supabaseClient
                    .from('bus_routes')
                    .select('*')
                    .order('route_number');

                // Load all driver assignments
                const { data: assignments, error: assignmentsError } = await window.supabaseClient
                    .from('driver_assignments')
                    .select('*')
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                // Load bus positions for real-time status
                const { data: positions, error: positionsError } = await window.supabaseClient
                    .from('bus_positions')
                    .select('*');

                if (!routesError && !assignmentsError) {
                    updateUnifiedRoutesTable(routes, assignments, positions || []);
                } else {
                    console.error('Error loading unified data:', routesError || assignmentsError);
                }
            } catch (e) {
                console.error('Failed to load unified routes:', e);
            }
        }

        // Update unified routes table
        function updateUnifiedRoutesTable(routes, assignments, positions) {
            const tbody = document.getElementById('unified-routes-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            // Combine routes and assignments data
            const combinedData = routes.map(route => {
                const assignment = assignments.find(a => String(a.route_number) === String(route.route_number));
                const position = positions.find(p => String(p.bus_no) === String(route.route_number));

                // Calculate scheduled trips for today based on bus schedule
                const today = new Date().getDay();
                const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][today];

                // Check if this route has a schedule for today
                let scheduledTripsToday = 0;
                const localRoute = addedRoutesData.find(r => r.busNo === route.route_number);
                if (localRoute && localRoute.schedule && localRoute.schedule[dayOfWeek]) {
                    scheduledTripsToday = 1; // One trip per day for each scheduled route
                } else {
                    // Check if it's in the default bus schedule
                    const defaultRoute = busScheduleData.find(r => r.busNo === route.route_number);
                    if (defaultRoute && defaultRoute.schedule && defaultRoute.schedule[dayOfWeek]) {
                        scheduledTripsToday = 1;
                    }
                }

                return {
                    ...route,
                    driver_name: assignment?.driver_name || 'Unassigned',
                    departure_time: assignment?.departure_time || 'N/A',
                    arrival_time: assignment?.last_arrival_time || 'N/A',
                    trips_today: assignment?.trips_today || scheduledTripsToday,
                    current_status: calculateDriverStatus(position),
                    assignment_id: assignment?.id || null,
                    is_user_added: localRoute ? true : false
                };
            });

            if (combinedData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-3 px-6 text-center text-gray-400">No routes found</td></tr>';
                return;
            }

            combinedData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.setAttribute('data-bus-no', item.route_number);
                row.setAttribute('data-is-user-added', item.is_user_added);

                // Check if route has valid route_number for deletion
                const hasValidRouteNumber = item.route_number && item.route_number !== 'N/A';

                row.innerHTML = `
                    <td class="py-3 px-6">${item.route_number || 'N/A'}</td>
                    <td class="py-3 px-6">${item.route_name || 'N/A'}</td>
                    <td class="py-3 px-6">${item.driver_name}</td>
                    <td class="py-3 px-6">${item.departure_time || 'N/A'}</td>
                    <td class="py-3 px-6">${item.arrival_time}</td>
                    <td class="py-3 px-6">${item.trips_today}</td>
                    <td class="py-3 px-6">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(item.current_status)}">
                            ${item.current_status}
                        </span>
                    </td>
                    <td class="py-3 px-6">
                        ${item.is_user_added ? `
                            <button onclick="editRoute('${item.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="deleteRoute('${item.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        ` : hasValidRouteNumber ? `
                            <button onclick="editSystemRoute('${item.route_number}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="deleteSystemRoute('${item.route_number}')" class="text-red-600 hover:text-red-900 mr-2">Delete</button>
                            <span class="text-gray-400 text-sm">System Route</span>
                        ` : `
                            <span class="text-gray-400 text-sm">Invalid Route Data</span>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit route function
        function editRoute(routeId) {
            const route = addedRoutesData.find(r => String(r.id) === String(routeId));
            if (!route) {
                showMessage('Route not found');
                return;
            }

            // Populate form with route data
            document.getElementById('bus-number').value = route.busNo;
            document.getElementById('route-name').value = route.route;
            document.getElementById('departure-time').value = route.departureTime;
            document.getElementById('eta').value = route.eta;

            // Clear and populate stops
            const stopsBuilder = document.getElementById('stops-builder');
            stopsBuilder.innerHTML = '';

            if (route.stops && route.stops.length > 0) {
                route.stops.forEach(stop => {
                    addStopRow(stop.name, stop.time);
                });
            } else {
                addStopRow(); // Add one empty row if no stops
            }

            // Update stops data
            updateStopsData();

            // Switch to manage tab and scroll to form
            hideAllSections();
            manageSection.classList.remove('hidden');
            setActiveTab(manageTab);

            // Scroll to form
            document.getElementById('add-bus-form').scrollIntoView({ behavior: 'smooth' });

            showMessage('Editing route: ' + route.route);
        }

        // Edit system route function
        function editSystemRoute(routeNumber) {
            // Find the system route from database routes first
            let systemRoute = busScheduleData.find(r => r.busNo === routeNumber);

            // If not found in busScheduleData, try to get from database
            if (!systemRoute && window.supabaseClient) {
                // Try to get from bus_routes table
                window.supabaseClient
                    .from('bus_routes')
                    .select('*')
                    .eq('route_number', routeNumber)
                    .single()
                    .then(({ data, error }) => {
                        if (!error && data) {
                            // Convert database route to expected format
                            systemRoute = {
                                busNo: data.route_number,
                                route: data.route_name,
                                stops: data.stops || [],
                                schedule: {} // Empty schedule for database routes
                            };
                            populateEditForm(systemRoute);
                        } else {
                            showMessage('System route not found in database');
                        }
                    })
                    .catch(e => {
                        console.error('Error loading system route:', e);
                        showMessage('Error loading system route');
                    });
            } else {
                populateEditForm(systemRoute);
            }
        }

        function populateEditForm(systemRoute) {
            // Populate form with system route data
            document.getElementById('bus-number').value = systemRoute.busNo;
            document.getElementById('route-name').value = systemRoute.route;

            // Set departure and ETA times from today's schedule
            const today = new Date().getDay();
            const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][today];
            const todaySchedule = systemRoute.schedule[dayOfWeek];

            if (todaySchedule) {
                // Convert 24h format to 12h format for display
                const depTime = todaySchedule.departureTime;
                const etaTime = todaySchedule.eta;

                if (depTime && depTime !== '--:--') {
                    const [hours, minutes] = depTime.split(':');
                    const hour12 = hours % 12 || 12;
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    document.getElementById('departure-time').value = `${hour12.toString().padStart(2, '0')}:${minutes}`;
                    if (departureAmPm) departureAmPm.value = ampm;
                }

                if (etaTime && etaTime !== '--:--') {
                    const [hours, minutes] = etaTime.split(':');
                    const hour12 = hours % 12 || 12;
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    document.getElementById('eta').value = `${hour12.toString().padStart(2, '0')}:${minutes}`;
                    if (etaAmPm) etaAmPm.value = ampm;
                }
            }

            // Clear and populate stops
            const stopsBuilder = document.getElementById('stops-builder');
            stopsBuilder.innerHTML = '';

            if (systemRoute.stops && systemRoute.stops.length > 0) {
                systemRoute.stops.forEach(stop => {
                    addStopRow(stop.name || stop, stop.time || stop.eta || '--:--');
                });
            } else {
                addStopRow(); // Add one empty row if no stops
            }

            // Update stops data
            updateStopsData();

            // Switch to manage tab and scroll to form
            hideAllSections();
            manageSection.classList.remove('hidden');
            setActiveTab(manageTab);

            // Scroll to form
            document.getElementById('add-bus-form').scrollIntoView({ behavior: 'smooth' });

            showMessage('Editing system route: ' + systemRoute.route + ' (Changes will create new user route)');
        }

        // Delete route function
        function deleteRoute(routeId) {
            if (!confirm('Are you sure you want to delete this route? This action cannot be undone.')) {
                return;
            }

            const routeIndex = addedRoutesData.findIndex(r => String(r.id) === String(routeId));
            if (routeIndex === -1) {
                showMessage('Route not found');
                return;
            }

            const route = addedRoutesData[routeIndex];

            // Remove from local data
            addedRoutesData.splice(routeIndex, 1);

            // Save to localStorage
            localStorage.setItem('userAddedRoutes', JSON.stringify(addedRoutesData));

            // Remove from database if it exists
            if (window.supabaseClient) {
                window.supabaseClient
                    .from('bus_routes')
                    .delete()
                    .eq('route_number', route.busNo)
                    .then(({ error }) => {
                        if (error) {
                            console.error('Error deleting route from database:', error);
                        }
                    });
            }

            // Refresh tables
            loadUnifiedRoutes();
            populateUserRoutesTable();

            showMessage('Route deleted successfully');
        }

        // Delete system route function
        async function deleteSystemRoute(routeNumber) {
            console.log('Attempting to delete route:', routeNumber);

            if (!confirm(`‚ö†Ô∏è WARNING: You are about to delete route "${routeNumber}". This action cannot be undone. Are you absolutely sure?`)) {
                return;
            }

            if (!window.supabaseClient) {
                showMessage('Database connection required');
                return;
            }

            try {
                // First, get the route data to find its ID
                console.log('Fetching route data for:', routeNumber);
                const { data: routeData, error: fetchError } = await window.supabaseClient
                    .from('bus_routes')
                    .select('id, route_number, route_name')
                    .eq('route_number', routeNumber)
                    .single();

                console.log('Fetch result:', { routeData, fetchError });

                if (fetchError || !routeData) {
                    console.error('Error fetching route:', fetchError);
                    showMessage(`‚ùå Route "${routeNumber}" not found in database. It may have already been deleted or was never saved.`);
                    // Refresh tables to sync with database
                    loadUnifiedRoutes();
                    populateUserRoutesTable();
                    return;
                }

                // Delete from route_stops first (foreign key constraint)
                const { error: stopsError } = await window.supabaseClient
                    .from('route_stops')
                    .delete()
                    .eq('route_id', routeData.id);

                if (stopsError) {
                    console.error('Error deleting route stops:', stopsError);
                    // Continue anyway, stops table might not exist
                }

                // Delete from bus_routes table
                const { error: deleteError } = await window.supabaseClient
                    .from('bus_routes')
                    .delete()
                    .eq('route_number', routeNumber);

                if (deleteError) {
                    console.error('Error deleting system route:', deleteError);
                    showMessage(`Failed to delete system route: ${deleteError.message}`);
                } else {
                    // Refresh tables
                    loadUnifiedRoutes();
                    populateUserRoutesTable();

                    showMessage('‚úÖ System route deleted successfully');
                }
            } catch (e) {
                console.error('Exception deleting system route:', e);
                showMessage(`Error deleting system route: ${e.message}`);
            }
        }

        // Calculate driver status
        function calculateDriverStatus(position) {
            if (!position) return 'Not Started';

            const lastUpdate = new Date(position.updated_at);
            const now = new Date();
            const minutesSinceUpdate = (now - lastUpdate) / (1000 * 60);

            if (minutesSinceUpdate > 5) return 'Stopped';
            if (position.speed > 5) return 'Going';
            if (position.speed > 0) return 'Riding';
            return 'Idle';
        }

        // Get status color
        function getStatusColor(status) {
            switch (status) {
                case 'Going': return 'bg-green-100 text-green-800';
                case 'Riding': return 'bg-blue-100 text-blue-800';
                case 'Stopped': return 'bg-red-100 text-red-800';
                case 'Idle': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Driver assignment form handler
        const assignDriverForm = document.getElementById('assign-driver-form');
        const driverBusNumberSelect = document.getElementById('driver-bus-number');
        const driverRouteNameInput = document.getElementById('driver-route-name');
        const driverDepartureTimeInput = document.getElementById('driver-departure-time');

        // Populate bus number dropdown and add change listener
        async function populateBusNumberDropdown() {
            if (!window.supabaseClient || !driverBusNumberSelect) return;

            try {
                const { data: routes, error } = await window.supabaseClient
                    .from('bus_routes')
                    .select('route_number, route_name, created_at')
                    .order('route_number');

                if (!error && routes) {
                    driverBusNumberSelect.innerHTML = '<option value="">Select Bus Number</option>';
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.route_number;
                        option.textContent = `${route.route_number} - ${route.route_name}`;
                        option.dataset.routeName = route.route_name;
                        option.dataset.routeNumber = route.route_number;
                        driverBusNumberSelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Error populating bus dropdown:', e);
            }
        }

        // Handle driver assignment form submission
        if (assignDriverForm) {
            assignDriverForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    const formData = new FormData(assignDriverForm);
                    const selectedOption = driverBusNumberSelect.options[driverBusNumberSelect.selectedIndex];
                    const routeName = selectedOption ? (selectedOption.getAttribute('data-route-name') || '') : '';

                    const driverData = {
                        driver_name: formData.get('driverName'),
                        // driver_phone: formData.get('driverPhone'), // Removed: Column not in DB schema
                        route_number: formData.get('driverBusNumber'), // Use route_number for foreign key
                        bus_no: formData.get('driverBusNumber'), // Added: Missing column required by DB constraint
                        route_name: routeName, // Added: Missing column required by DB constraint
                        status: 'active',
                        created_at: new Date().toISOString()
                    };

                    if (!window.supabaseClient) {
                        showMessage('Database connection required');
                        hideLoading();
                        return;
                    }

                    const { error } = await window.supabaseClient
                        .from('driver_assignments')
                        .insert([driverData]);

                    if (error) {
                        showMessage(`Failed to assign driver: ${error.message}`);
                    } else {
                        showMessage('‚úÖ Driver assigned successfully!');
                        assignDriverForm.reset();
                        driverRouteNameInput.value = '';
                        loadUnifiedRoutes(); // Refresh unified table
                    }
                } catch (e) {
                    showMessage(`Error assigning driver: ${e.message}`);
                } finally {
                    hideLoading();
                }
            });
        }

        // Initialize bus dropdown when manage tab is opened
        const originalLoadUnifiedRoutes = loadUnifiedRoutes;
        loadUnifiedRoutes = async function () {
            await originalLoadUnifiedRoutes();
            await populateBusNumberDropdown();
        };

        function updateView() {
            // No need to toggle, as we're always in admin mode
        }

        function setActiveTab(activeBtn) {
            const tabs = [dashboardTab, scheduleTab, manageTab, loginsTab];
            tabs.forEach(btn => {
                if (!btn) return;
                const isActive = btn === activeBtn;
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                btn.classList.toggle('bg-gray-200', isActive);
                btn.classList.toggle('text-gray-800', isActive);
                btn.classList.toggle('text-gray-600', !isActive);
            });
        }

        // Dashboard open via branding clicks (no showDashboard function)
        if (logo) {
            logo.addEventListener('click', () => {
                hideAllSections();
                dashboardSection.classList.remove('hidden');
                try { initCollegeMap(); } catch (_) { }
                try { initLiveBusesAdmin(); } catch (_) { }
                try { refreshDashboardStats(); } catch (_) { }
                try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch (_) { }
                try { location.hash = '#dashboard'; } catch (_) { }
            });
        }
        if (siteTitle) {
            siteTitle.addEventListener('click', () => {
                hideAllSections();
                dashboardSection.classList.remove('hidden');
                try { initCollegeMap(); } catch (_) { }
                try { initLiveBusesAdmin(); } catch (_) { }
                try { refreshDashboardStats(); } catch (_) { }
                try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch (_) { }
                try { location.hash = '#dashboard'; } catch (_) { }
            });
        }

        scheduleTab.addEventListener('click', () => {
            hideAllSections();
            scheduleSection.classList.remove('hidden');
            generateWeeklyDates(); // Populate the weekly dates for students
            populateScheduleTable(new Date()); // Load today's schedule by default
            startLiveTimeTracking(); // Start live time tracking
            try { setActiveTab(scheduleTab); location.hash = '#schedule'; } catch (_) { }
        });

        manageTab.addEventListener('click', () => {
            hideAllSections();
            manageSection.classList.remove('hidden');
            loadUnifiedRoutes();
            try { setActiveTab(manageTab); location.hash = '#manage'; } catch (_) { }
        });

        loginsTab.addEventListener('click', () => {
            hideAllSections();
            loginsSection.classList.remove('hidden');
            loadLoginLogs();
            try { setActiveTab(loginsTab); location.hash = '#logins'; } catch (_) { }
        });

        refreshLogsBtn.addEventListener('click', loadLoginLogs);
        clearLogsBtn.addEventListener('click', () => {
            clearLoginLogs();
            showMessage('Login logs cleared');
        });

        if (logoutBtn) { logoutBtn.addEventListener('click', logoutAdmin); }

        // Unfreeze Route dropdown handler
        const unfreezeRouteSelect = document.getElementById('unfreeze-route-select');

        // Function to load active route assignments into dropdown
        async function loadActiveRoutesDropdown() {
            if (!unfreezeRouteSelect || !window.supabaseClient) return;

            try {
                const { data, error } = await window.supabaseClient
                    .from('active_route_assignments')
                    .select('id, route_number, route_name, driver_id, started_at')
                    .eq('status', 'active')
                    .order('started_at', { ascending: false });

                // Clear existing options except the first one
                unfreezeRouteSelect.innerHTML = '<option value="">üîì Unfreeze Route</option>';

                if (!error && data && data.length > 0) {
                    data.forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.id;
                        const routeLabel = `${assignment.route_number}${assignment.route_name ? ' - ' + assignment.route_name : ''}`;
                        const driverLabel = assignment.driver_id;
                        const timeAgo = getTimeAgo(new Date(assignment.started_at));
                        option.textContent = `${routeLabel} (${driverLabel}) - ${timeAgo}`;
                        unfreezeRouteSelect.appendChild(option);
                    });
                    unfreezeRouteSelect.disabled = false;
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '‚úÖ No routes to unfreeze';
                    option.disabled = true;
                    unfreezeRouteSelect.appendChild(option);
                    unfreezeRouteSelect.disabled = true;
                }
            } catch (e) {
                console.error('Error loading active routes:', e);
            }
        }

        // Helper function to calculate time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }

        // Handle dropdown selection
        if (unfreezeRouteSelect) {
            console.log('Unfreeze dropdown found, attaching event listener');

            unfreezeRouteSelect.addEventListener('change', async (e) => {
                const assignmentId = e.target.value;
                console.log('Dropdown changed, selected value:', assignmentId);

                if (!assignmentId) {
                    console.log('No assignment ID, returning');
                    return;
                }

                try {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    const routeText = selectedOption.textContent;
                    console.log('Selected route:', routeText);

                    const confirmed = confirm(`‚ö†Ô∏è Unfreeze this route?\n\n${routeText}\n\nThis will stop the driver's tracking and make the route available again.\n\nContinue?`);
                    if (!confirmed) {
                        e.target.value = ''; // Reset selection
                        return;
                    }

                    if (!window.supabaseClient) {
                        alert('Supabase client not initialized');
                        e.target.value = '';
                        return;
                    }

                    console.log('Unfreezing route with ID:', assignmentId);

                    // Update the specific assignment to stopped
                    const { data, error } = await window.supabaseClient
                        .from('active_route_assignments')
                        .update({ status: 'stopped', stopped_at: new Date().toISOString() })
                        .eq('id', assignmentId)
                        .select();

                    if (error) {
                        console.error('Unfreeze route error:', error);
                        alert('Failed to unfreeze route: ' + error.message);
                    } else {
                        alert(`‚úÖ Route unfrozen successfully!\n\nThe route is now available for other drivers.`);
                        console.log('Unfrozen route:', data);
                        // Reload the dropdown
                        await loadActiveRoutesDropdown();
                    }
                } catch (e) {
                    console.error('Unfreeze route exception:', e);
                    alert('Failed to unfreeze route: ' + e.message);
                }

                // Reset selection
                e.target.value = '';
            });

            // Load active routes on page load
            console.log('Loading active routes on page load');
            loadActiveRoutesDropdown();

            // Refresh dropdown every 30 seconds
            setInterval(loadActiveRoutesDropdown, 30000);
        } else {
            console.error('Unfreeze dropdown not found!');
        }

        addBusForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const busNumber = busNumberInput.value;
            const routeName = routeNameInput.value;
            const departureTime = departureTimeInput.value; // HH:MM (input)
            const eta = etaInput.value; // HH:MM (input)
            const departureMeridiem = (departureAmPm && departureAmPm.value) ? departureAmPm.value : 'AM';
            const etaMeridiem = (etaAmPm && etaAmPm.value) ? etaAmPm.value : 'AM';
            const dep24 = to24h((departureTime || '').slice(0, 5), departureMeridiem);
            const eta24 = to24h((eta || '').slice(0, 5), etaMeridiem);

            // Validate bus number format
            if (!busNumber.match(/^[A-Z0-9]{3,6}$/)) {
                hideLoading();
                showMessage('‚ùå Invalid Bus Number format. Please use format like "R001", "R002", etc.');
                return;
            }

            // Check if bus number already exists before saving
            try {
                const { data: existingRoutes, error: checkError } = await window.supabaseClient
                    .from('bus_routes')
                    .select('route_number')
                    .eq('route_number', busNumber);

                if (checkError) {
                    console.error('Error checking existing route:', checkError);
                    showMessage('Database error while checking for existing routes');
                    hideLoading();
                    return;
                } else if (existingRoutes && existingRoutes.length > 0) {
                    hideLoading();
                    showMessage(`‚ùå Bus Number "${busNumber}" already exists in database. Please use a different bus number.`);
                    showMessage('üí° Each bus must have a unique identifier. Current conflicts: ' + existingRoutes.map(r => r.route_number).join(', '));
                    return;
                }
            } catch (e) {
                console.error('Error during route validation:', e);
                showMessage('Database error during validation check');
                hideLoading();
                return;
            }

            // Re-read stops from the builder UI
            updateStopsTextarea();
            const stopsData = stopsDataTextarea.value;
            const parsedStops = parseStops(stopsData);

            if (parsedStops.length === 0) {
                hideLoading();
                showMessage('Please add at least one stop to the route.');
                return;
            }

            // Auto-sync first and last stop times to match selected departure/ETA in 24h format
            try {
                parsedStops[0].time = dep24;
                parsedStops[parsedStops.length - 1].time = eta24;
            } catch (_) { }

            // Define start/end points (defaults as inputs are missing)
            const startPoint = 'Vel Tech';
            const endPoint = 'Destination';

            const newOrUpdatedRoute = {
                busNo: busNumber,
                route: routeName,
                startPoint: startPoint, // <--- ADD THIS
                endPoint: endPoint,     // <--- ADD THIS
                schedule: {},
                stops: parsedStops,
                isUserAdded: true
            };

            // Populate schedule for all days of the week for the new route
            daysOfWeek.forEach(day => {
                newOrUpdatedRoute.schedule[day] = {
                    departureTime: dep24,
                    eta: eta24
                };
            });

            setTimeout(async () => { // Use setTimeout to allow loading spinner to show
                let message = '';
                const synced = await syncRouteToDB(newOrUpdatedRoute);

                if (!synced) {
                    hideLoading();
                    showMessage('Failed to save route. Please ensure the Bus Number is unique and the database is configured correctly.');
                    return;
                }

                // Determine message based on editing state
                if (isEditing) {
                    message = `Bus route ${busNumber} updated successfully!`;
                    isEditing = false;
                    editingIndex = -1;
                    submitBtn.textContent = 'Add Bus';
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                } else {
                    message = `New bus route ${busNumber} added!`;
                }

                // Refresh local data from DB after sync to ensure consistency (especially needed for cascade deletes/updates)
                await loadRoutes();

                showMessage(message);

                addBusForm.reset();
                // Reset form fields and stops builder to blanks; admin will set times as needed
                if (departureTimeInput) departureTimeInput.value = '';
                if (etaInput) etaInput.value = '';
                if (departureAmPm) departureAmPm.value = 'AM';
                if (etaAmPm) etaAmPm.value = 'AM';
                if (stopsBuilder) {
                    stopsBuilder.innerHTML = '';
                    addStopRow('', '');
                    updateStopsTextarea();
                }

                populateUserRoutesTable();
                const dateForTable = scheduleDateInput.value ? new Date(scheduleDateInput.value) : new Date();
                populateScheduleTable(dateForTable);
                hideLoading();

                try { refreshDashboardStats(); } catch (_) { }
            }, 500);
        });



        messageOkBtn.addEventListener('click', hideMessage);

        // --- Cancel Notes Logic ---
        const cancelNotesBtn = document.getElementById('cancel-notes-btn');

        if (editNotesBtn) {
            editNotesBtn.addEventListener('click', () => {
                isNotesEditing = true;
                if (adminNotesDisplay) {
                    adminNotesDisplay.classList.add('hidden');
                    // Pre-fill textarea with current notes (removing any HTML tags if simple text)
                    adminNotesTextarea.value = adminNotesDisplay.textContent.trim();
                }
                if (adminNotesTextarea) adminNotesTextarea.classList.remove('hidden');
                if (saveNotesBtn) saveNotesBtn.classList.remove('hidden');
                if (cancelNotesBtn) cancelNotesBtn.classList.remove('hidden');
                if (editNotesBtn) editNotesBtn.classList.add('hidden');
            });
        }

        if (cancelNotesBtn) {
            cancelNotesBtn.addEventListener('click', () => {
                isNotesEditing = false;
                if (adminNotesTextarea) {
                    adminNotesTextarea.classList.add('hidden');
                    adminNotesTextarea.value = ''; // Clear edit
                }
                if (saveNotesBtn) saveNotesBtn.classList.add('hidden');
                if (cancelNotesBtn) cancelNotesBtn.classList.add('hidden');
                if (editNotesBtn) editNotesBtn.classList.remove('hidden');
                if (adminNotesDisplay) adminNotesDisplay.classList.remove('hidden');
            });
        }

        if (saveNotesBtn) saveNotesBtn.addEventListener('click', saveAdminNote);


        // --- Change Password Logic ---
        if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', () => {
                if (changePasswordModal) {
                    changePasswordModal.classList.remove('hidden');
                    // Reset form
                    if (changePasswordForm) changePasswordForm.reset();
                    if (cpError) cpError.classList.add('hidden');
                    if (cpSuccess) cpSuccess.classList.add('hidden');
                }
            });
        }

        if (closeChangePasswordModalBtn) {
            closeChangePasswordModalBtn.addEventListener('click', () => {
                if (changePasswordModal) changePasswordModal.classList.add('hidden');
            });
        }

        if (cpCancel) {
            cpCancel.addEventListener('click', () => {
                if (changePasswordModal) changePasswordModal.classList.add('hidden');
            });
        }

        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (cpError) cpError.classList.add('hidden');
                if (cpSuccess) cpSuccess.classList.add('hidden');

                const currentPwd = cpCurrent.value;
                const newPwd = cpNew.value;
                const confirmPwd = cpConfirm.value;

                if (!newPwd || !confirmPwd) { // Current pwd might not be needed if session is active, keeping it simple
                    if (cpError) {
                        cpError.textContent = 'Please fill in all fields.';
                        cpError.classList.remove('hidden');
                    }
                    return;
                }

                if (newPwd !== confirmPwd) {
                    if (cpError) {
                        cpError.textContent = 'New passwords do not match.';
                        cpError.classList.remove('hidden');
                    }
                    return;
                }

                if (newPwd.length < 6) {
                    if (cpError) {
                        cpError.textContent = 'Password must be at least 6 characters.';
                        cpError.classList.remove('hidden');
                    }
                    return;
                }

                showLoading();

                try {
                    if (!window.supabaseClient) throw new Error('Database connection failed');

                    // If we are using Supabase Auth, we can update the user directly
                    const { data, error } = await window.supabaseClient.auth.updateUser({
                        password: newPwd
                    });

                    if (error) {
                        throw error;
                    }

                    if (cpSuccess) {
                        cpSuccess.textContent = '‚úÖ Password updated successfully!';
                        cpSuccess.classList.remove('hidden');
                    }

                    setTimeout(() => {
                        if (changePasswordModal) changePasswordModal.classList.add('hidden');
                        if (cpSuccess) cpSuccess.classList.add('hidden');
                    }, 1500);

                } catch (err) {
                    console.error('Password update error:', err);
                    if (cpError) {
                        cpError.textContent = err.message || 'Failed to update password.';
                        cpError.classList.remove('hidden');
                    }
                } finally {
                    hideLoading();
                }
            });
        }

        // Add null checks for all event listeners
        function safeAddEventListener(element, event, handler) {
            if (element) {
                element.addEventListener(event, handler);
            } else {
                console.warn(`Element not found for ${event} listener:`, element);
            }
        }

        // Apply safe event listeners to critical elements
        safeAddEventListener(scheduleDateInput, 'change', (e) => {
            if (e && e.target) {
                populateScheduleTable(new Date(e.target.value));
            }
        });

        scheduleTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row) {
                const busNo = row.getAttribute('data-bus-no');
                const isUserAdded = row.getAttribute('data-is-added') === 'true';
                showStops(busNo, isUserAdded);
            }
        });

        closeStopsModal.addEventListener('click', hideStopsModal);

        // Initial setup
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Admin interface initializing...');

            try {
                // FIX: Ensure modal is hidden on load (critical fix)
                hideStopsModal();
                console.log('Modal hidden on load');

                // Load any saved routes
                addedRoutesData = await loadRoutes();
                console.log('Routes loaded');

                // Display the dashboard by default
                dashboardSection.classList.remove('hidden');
                initCollegeMap();
                try { initLiveBusesAdmin(); } catch (_) { }
                // Initial KPI refresh and periodic updates (visibility-aware)
                try { refreshDashboardStats(); } catch (_) { }
                try {
                    if (window._adminKpiTimer) { clearInterval(window._adminKpiTimer); }
                    window._adminKpiTimer = setInterval(refreshDashboardStats, 15000);
                    document.addEventListener('visibilitychange', () => {
                        try {
                            if (document.hidden) {
                                if (window._adminKpiTimer) { clearInterval(window._adminKpiTimer); window._adminKpiTimer = null; }
                                if (_adminBusPollTimer) { clearInterval(_adminBusPollTimer); _adminBusPollTimer = null; }
                            } else {
                                refreshDashboardStats();
                                if (!window._adminKpiTimer) { window._adminKpiTimer = setInterval(refreshDashboardStats, 15000); }
                                if (!_adminBusPollTimer) { _adminBusPollTimer = setInterval(loadCurrentBusPositionsAdmin, 10000); }
                            }
                        } catch (_) { }
                    });
                } catch (_) { }
                console.log('Dashboard section shown');

                // Initialize admin notes
                initializeAdminNotes();
                console.log('Admin notes initialized');

                // Start the clock
                updateTime();
                setInterval(updateTime, 1000);
                console.log('Clock started');

                // Populate initial schedule
                populateScheduleTable(new Date());
                console.log('Schedule populated');

                updateView();
                console.log('View updated');

                emergencyLastSeen = loadEmergencyLastSeen();
                await loadEmergencyAlerts(true);
                subscribeEmergencyAlerts();
                if (emergencyAlertsList) {
                    emergencyAlertsList.addEventListener('click', () => {
                        if (emergencyAlerts && emergencyAlerts.length > 0) {
                            markEmergencyAlertsSeen(emergencyAlerts[0]?.created_at || new Date());
                            renderEmergencyAlerts();
                        }
                    });
                }

                // Hash routing: #dashboard, #schedule, #manage, #logins
                if (location.hash) {
                    const h = location.hash;
                    if (h === '#dashboard') {
                        hideAllSections();
                        dashboardSection.classList.remove('hidden');
                        try { initCollegeMap(); } catch (_) { }
                        try { initLiveBusesAdmin(); } catch (_) { }
                        try { refreshDashboardStats(); } catch (_) { }
                        try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch (_) { }
                    } else if (h === '#schedule') {
                        hideAllSections();
                        scheduleSection.classList.remove('hidden');
                        generateWeeklyDates();
                        populateScheduleTable(new Date());
                        setActiveTab(scheduleTab);
                    } else if (h === '#manage') {
                        hideAllSections();
                        manageSection.classList.remove('hidden');
                        populateUserRoutesTable();
                        setActiveTab(manageTab);
                    } else if (h === '#logins') {
                        hideAllSections();
                        loginsSection.classList.remove('hidden');
                        loadLoginLogs();
                        setActiveTab(loginsTab);
                    }
                }

                console.log('Admin interface initialization complete');
            } catch (error) {
                console.error('Error during admin interface initialization:', error);
            }
        });

        // Live time tracking for bus schedule
        let liveTimeInterval;
        function startLiveTimeTracking() {
            // Clear any existing interval
            if (liveTimeInterval) {
                clearInterval(liveTimeInterval);
            }

            // Update time every second
            liveTimeInterval = setInterval(() => {
                updateLiveScheduleTimes();
            }, 1000);

            // Initial update
            updateLiveScheduleTimes();
        }

        function updateLiveScheduleTimes() {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM format

            // Update all time cells in the schedule table
            const timeCells = document.querySelectorAll('.schedule-time-cell');
            timeCells.forEach(cell => {
                const scheduledTime = cell.textContent;
                if (scheduledTime && scheduledTime !== '--:--') {
                    // Calculate time difference
                    const [scheduledHours, scheduledMinutes] = scheduledTime.split(':').map(Number);
                    const [currentHours, currentMinutes] = currentTime.split(':').map(Number);

                    const scheduledTotalMinutes = scheduledHours * 60 + scheduledMinutes;
                    const currentTotalMinutes = currentHours * 60 + currentMinutes;

                    const diffMinutes = scheduledTotalMinutes - currentTotalMinutes;

                    // Update cell with live status
                    if (diffMinutes < -30) {
                        cell.innerHTML = `${scheduledTime} <span class="text-red-600 text-xs">(Departed)</span>`;
                    } else if (diffMinutes <= 0 && diffMinutes > -30) {
                        cell.innerHTML = `${scheduledTime} <span class="text-green-600 text-xs">(Now)</span>`;
                    } else if (diffMinutes <= 15) {
                        cell.innerHTML = `${scheduledTime} <span class="text-yellow-600 text-xs">(${diffMinutes}m)</span>`;
                    } else {
                        cell.innerHTML = scheduledTime;
                    }
                }
            });
        }

        // Stop live tracking when leaving schedule tab
        function stopLiveTimeTracking() {
            if (liveTimeInterval) {
                clearInterval(liveTimeInterval);
                let liveTimeInterval = null;
            }
        }

        // Add tab switching logic to stop/start live tracking
        const allTabs = [dashboardTab,]

        // Add null checks for all event listeners
        function safeAddEventListener(element, event, handler) {
            if (element) {
                element.addEventListener(event, handler);
            } else {
                console.warn(`Element not found for ${event} listener:`, element);
            }
        }

        // Apply safe event listeners to critical elements
        safeAddEventListener(saveNotesBtn, 'click', async () => {
            if (isNotesEditing) {
                saveAdminNote();
            }
        });

        // Load notifications when notifications tab is opened
        const notificationForm = document.getElementById('notification-form');
        if (notificationForm) {
            notificationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    const recipient = document.getElementById('notification-recipient').value;
                    const busNumber = document.getElementById('notification-bus').value;
                    const title = document.getElementById('notification-title').value;
                    const message = document.getElementById('notification-message').value;
                    const type = document.getElementById('notification-type').value;

                    if (!window.supabaseClient) {
                        showMessage('Database connection required');
                        hideLoading();
                        return;
                    }

                    const notificationData = {
                        recipient_type: recipient,
                        specific_bus: busNumber, // Corrected column name per user SQL
                        title,
                        message,
                        notification_type: type, // Corrected column name matches DB schema
                        created_at: new Date().toISOString()
                    };

                    const { error } = await window.supabaseClient
                        .from('notifications')
                        .insert([notificationData]);

                    if (error) {
                        showMessage(`Failed to send notification: ${error.message}`);
                    } else {
                        showMessage('‚úÖ Notification sent successfully!');
                        notificationForm.reset();
                        loadRecentNotifications();
                    }
                } catch (e) {
                    showMessage(`Error sending notification: ${e.message}`);
                } finally {
                    hideLoading();
                }
            });
        }

        // Load recent notifications
        async function loadRecentNotifications() {
            if (!window.supabaseClient) return;

            try {
                // First, clean up old notifications (older than 7 days)
                await deleteOldNotifications();

                // Then fetch the remaining valid ones (last 7 days)
                const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                const { data, error } = await window.supabaseClient
                    .from('notifications')
                    .select('*')
                    .gte('created_at', sevenDaysAgo)
                    .order('created_at', { ascending: false }); // Removed limit to show all from last week

                if (!error && data) {
                    const notificationsList = document.getElementById('recent-notifications-list');
                    if (notificationsList) {
                        if (data.length === 0) {
                            notificationsList.innerHTML = '<p class="text-gray-500 text-center py-4">No notifications in the last 7 days.</p>';
                        } else {
                            notificationsList.innerHTML = data.map(notification => `
                                <div class="p-3 bg-white hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors mb-2">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="font-semibold text-gray-900">${notification.title}</span>
                                                <span class="px-2 py-0.5 text-xs font-medium rounded-full ${getNotificationTypeColor(notification.notification_type)} border border-opacity-20">
                                                    ${notification.notification_type.toUpperCase()}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600 leading-snug">${notification.message}</p>
                                        </div>
                                        <span class="text-xs text-gray-400 whitespace-nowrap ml-2 bg-gray-50 px-2 py-1 rounded">${new Date(notification.created_at).toLocaleString()}</span>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-500 flex items-center gap-2">
                                        <span class="inline-flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" /></svg>
                                            To: <strong>${notification.recipient_type || 'All'}</strong>
                                        </span>
                                        ${notification.specific_bus ? `
                                        <span class="inline-flex items-center gap-1 text-blue-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                            Bus: <strong>${notification.specific_bus}</strong>
                                        </span>` : ''}
                                    </div>
                                </div>
                            `).join('');
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading recent notifications:', e);
            }
        }

        async function deleteOldNotifications() {
            if (!window.supabaseClient) return;
            try {
                // Delete notifications older than 7 days
                const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                const { error } = await window.supabaseClient
                    .from('notifications')
                    .delete()
                    .lt('created_at', sevenDaysAgo);

                if (error) {
                    console.warn('Could not auto-delete old notifications (check RLS policies):', error.message);
                } else {
                    console.log('Old notifications cleanup complete.');
                }
            } catch (e) {
                console.error('Error in deleteOldNotifications:', e);
            }
        }

        function getNotificationTypeColor(type) {
            switch (type) {
                case 'info': return 'bg-blue-100 text-blue-800';
                case 'warning': return 'bg-yellow-100 text-yellow-800';
                case 'emergency': return 'bg-red-100 text-red-800';
                case 'success': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Load notifications when notifications tab is opened
        if (studentsSubtabNotifications) {
            studentsSubtabNotifications.addEventListener('click', () => {
                loadRecentNotifications();
            });
        }
        // Clear all notifications logic
        const clearNotificationsBtn = document.getElementById('clear-notifications-btn');
        if (clearNotificationsBtn) {
            clearNotificationsBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to clear ALL notification history? This cannot be undone.')) {
                    await clearAllNotifications();
                }
            });
        }

        async function clearAllNotifications() {
            if (!window.supabaseClient) return;
            showLoading();
            try {
                const { error } = await window.supabaseClient
                    .from('notifications')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Hack to delete all rows if no primary key filter is allowed usually

                if (error) {
                    console.error('Error clearing notifications:', error);
                    showMessage(`Failed to clear history: ${error.message}`);
                } else {
                    showMessage('‚úÖ Notification history cleared successfully');
                    loadRecentNotifications();
                }
            } catch (e) {
                console.error('Error in clearAllNotifications:', e);
                showMessage(`Error: ${e.message}`);
            } finally {
                hideLoading();
            }
        }
    </script>
</body>

</html>