<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vel Tech Bus Management</title>
    <link rel="stylesheet" href="css/output.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col relative z-0" data-mode="student">
    <!-- Main Application Container -->
    <div class="flex-grow flex flex-col p-4 md:p-8">

        <!-- Header -->
        <header class="bg-white rounded-xl shadow-md p-4 mb-8 relative z-30">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <img id="logo" src="images/vt.jpg" alt="Vel Tech Logo" class="h-12 w-auto cursor-pointer">
                    <h1 id="site-title" class="text-2xl md:text-3xl font-bold text-gray-800 cursor-pointer">Vel Tech Bus
                        Management</h1>
                </div>
                <!-- Navigation Tabs -->
                <nav class="flex space-x-2 md:space-x-4 items-center" role="tablist">
                    <div class="relative z-50 mr-4">
                        <button id="notification-btn" type="button"
                            class="flex items-center justify-center p-3 bg-white text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-full shadow-md border border-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <span id="notification-badge"
                                class="absolute -top-1 -right-1 inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1 text-xs font-bold leading-none text-white bg-red-600 rounded-full border-2 border-white shadow-sm hidden">0</span>
                        </button>

                        <!-- Notification Dropdown -->
                        <div id="notification-dropdown"
                            class="absolute right-0 mt-3 w-96 origin-top-right bg-white rounded-xl shadow-2xl ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50">
                            <div class="py-1" role="menu" aria-orientation="vertical"
                                aria-labelledby="notification-btn">
                                <div
                                    class="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                                    <span class="text-base font-semibold text-gray-800">Notifications</span>
                                    <button id="mark-all-read"
                                        class="text-xs font-medium text-blue-600 hover:text-blue-800 hover:underline">Mark
                                        all read</button>
                                </div>
                                <div id="notification-list" class="max-h-[20rem] overflow-y-auto overscroll-contain">
                                    <div class="px-4 py-8 text-sm text-gray-500 text-center flex flex-col items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-300 mb-2"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                        </svg>
                                        <p>No new notifications</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="dashboard-tab" role="tab" aria-controls="dashboard-section" aria-selected="true"
                        class="px-3 py-2 md:px-4 md:py-2 font-medium text-gray-600 rounded-lg hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200 bg-gray-200 text-gray-800">Dashboard<span
                            id="dashboard-notes-dot"
                            class="hidden ml-2 inline-flex h-2 w-2 rounded-full bg-red-600"></span></button>
                    <button id="schedule-tab" role="tab" aria-controls="schedule-section" aria-selected="false"
                        class="px-3 py-2 md:px-4 md:py-2 font-medium text-gray-600 rounded-lg hover:bg-gray-200 focus:outline-none focus:bg-gray-200 transition-colors duration-200">Bus
                        Schedule</button>
                    <button id="student-logout-btn"
                        class="px-3 py-2 md:px-4 md:py-2 font-medium text-white bg-gray-600 rounded-lg hover:bg-gray-700 focus:outline-none focus:bg-gray-700 transition-colors duration-200">Logout</button>
                </nav>

            </div>
        </header>

        <!-- Dynamic Content Sections -->
        <main class="flex-grow relative z-10">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Dashboard Cards -->
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Active Buses</p>
                            <h2 class="text-3xl font-semibold text-gray-800" id="active-buses-count">0</h2>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.553-.894L11 8m0 0l-5 2.5a1 1 0 010 1.789l5 2.5m0 0l7.585-3.793a1 1 0 01.915-.028L19 12m-8 2l8 4" />
                        </svg>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">On-Time Departures</p>
                            <h2 class="text-3xl font-semibold text-gray-800" id="on-time-count">0</h2>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>


                </div>

                <div class="mt-8 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">College Location & Live Map</h2>
                    <div id="map-placeholder" class="bg-gray-200 rounded-lg h-96 overflow-hidden cursor-pointer">
                        <div id="college-map-student" class="w-full h-full"></div>
                    </div>
                </div>

                <!-- Admin Notes and Helpline Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div id="admin-notes-card" class="bg-white p-6 rounded-xl shadow-md cursor-pointer">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Special Notes from Admin</h3>
                            <span id="admin-notes-badge"
                                class="hidden px-2 py-0.5 text-xs font-semibold text-white bg-red-600 rounded-full">New</span>
                        </div>
                        <p id="admin-notes-display" class="text-gray-600">
                            Loading notes...
                        </p>
                        <textarea id="admin-notes-textarea"
                            class="hidden w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button id="save-notes-btn"
                            class="hidden mt-2 px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">Save</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Helpline Numbers</h3>
                            <button id="emergency-btn"
                                class="px-4 py-2 font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:bg-red-700 transition-colors duration-200 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                </svg>
                                <span>Emergency</span>
                            </button>
                        </div>
                        <ul class="list-disc list-inside space-y-2 text-gray-600">
                            <li>Transport Office: 98765 43210</li>
                            <li>Bus Coordinator: 99887 76655</li>
                            <li>Emergency Services: 100</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Bus Schedule Section -->
            <section id="schedule-section" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Bus Schedule</h2>
                        <div id="weekly-dates-container" class="flex flex-wrap gap-2 mt-2 md:mt-0">
                            <!-- Weekly dates will be populated here -->
                        </div>
                        <p id="current-time" class="text-lg font-bold text-gray-700 ml-4"></p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto border-collapse">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Bus No.</th>
                                    <th class="py-3 px-6 text-left">Route</th>
                                    <th class="py-3 px-6 text-left">Departure Time</th>
                                    <th class="py-3 px-6 text-left rounded-tr-lg">ETA</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body" class="text-gray-600 text-sm font-medium">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


        </main>

        <!-- Loading Spinner -->
        <div id="loading-spinner"
            class="fixed inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 z-[99] hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        </div>

        <!-- Custom Message Box -->
        <div id="message-box" class="message-box hidden bg-white p-6 rounded-xl shadow-lg border border-gray-300">
            <p id="message-text" class="text-center font-medium text-gray-800"></p>
            <div class="flex justify-center mt-4">
                <button id="message-ok"
                    class="px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>

        <!-- Emergency Modal -->
        <div id="emergency-modal" class="modal hidden">
            <div class="modal-content max-w-md" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="emergency-modal-title" class="text-xl font-bold text-red-600">ðŸš¨ Emergency</h2>
                    <button id="close-emergency-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>

                <!-- Panic Button Section -->
                <div class="mb-6">
                    <button id="panic-button"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition-colors duration-200">
                        ðŸš¨ PANIC BUTTON
                    </button>
                    <p class="text-sm text-gray-600 text-center mt-2">Press only in case of real emergency</p>
                </div>

                <!-- Emergency Contacts -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Emergency Contacts</h3>
                    <div id="emergency-contacts" class="space-y-2">
                        <!-- Contacts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Stops Modal -->
        <div id="stops-modal" class="modal hidden">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="stops-modal-title" class="text-xl font-bold">Bus Stops</h2>
                    <button id="close-stops-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <!-- Bus stops table will be populated here -->
                <table class="w-full table-auto border-collapse">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Stop</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">ETA</th>
                        </tr>
                    </thead>
                    <tbody id="stops-table-body" class="text-gray-600 text-sm font-medium">
                        <!-- Stops will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white text-center p-4 mt-8 rounded-xl shadow-md">
            <p>&copy; 2024 Vel Tech Bus Management. All Rights Reserved.</p>
        </footer>
    </div>

    <!-- JavaScript for dynamic functionality -->
    <script>
        // Auth guard: require local student login
        (function () {
            try {
                if (localStorage.getItem('vt_student_authed') !== 'true') {
                    window.location.href = 'student-login.html';
                }
            } catch (e) { }
        })();

        // --- Data Mockup (expanded) ---
        const busScheduleData = [];

        // Routes created by admin (fetched from DB)
        let adminAddedRoutes = [];
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // --- DOM Elements ---
        const dashboardTab = document.getElementById('dashboard-tab');
        const scheduleTab = document.getElementById('schedule-tab');
        const studentLogoutBtn = document.getElementById('student-logout-btn');
        const logo = document.getElementById('logo');
        const siteTitle = document.getElementById('site-title');


        const dashboardSection = document.getElementById('dashboard-section');
        const scheduleSection = document.getElementById('schedule-section');


        const scheduleTableBody = document.getElementById('schedule-table-body');

        const currentTimeEl = document.getElementById('current-time');

        const weeklyDatesContainer = document.getElementById('weekly-dates-container');

        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok');

        const stopsModal = document.getElementById('stops-modal');
        const stopsModalTitle = document.getElementById('stops-modal-title');
        const stopsTableBody = document.getElementById('stops-table-body');
        const closeStopsModal = document.getElementById('close-stops-modal');


        // Emergency modal elements
        const emergencyBtn = document.getElementById('emergency-btn');
        const emergencyModal = document.getElementById('emergency-modal');
        const closeEmergencyModal = document.getElementById('close-emergency-modal');
        const panicButton = document.getElementById('panic-button');
        const emergencyContacts = document.getElementById('emergency-contacts');

        // Immediately hide modals on page load
        if (stopsModal) {
            stopsModal.classList.add('hidden');
        }
        if (emergencyModal) {
            emergencyModal.classList.add('hidden');
        }


        // Admin Notes elements
        const adminNotesDisplay = document.getElementById('admin-notes-display');
        const adminNotesCard = document.getElementById('admin-notes-card');
        const adminNotesBadge = document.getElementById('admin-notes-badge');
        const dashboardNotesDot = document.getElementById('dashboard-notes-dot');


        let isEditing = false;
        let editingIndex = -1;
        // --- Functions ---

        /**
         * Hides all content sections.
         */
        function hideAllSections() {
            dashboardSection.classList.add('hidden');
            scheduleSection.classList.add('hidden');

        }

        // Log student login via RPC (Option B)
        async function logStudentLogin() {
            if (!window.supabaseClient) return;
            try {
                // Since this uses anon/authenticated role, we don't need the session check
                // but we need to pass student data
                const studentId = localStorage.getItem('vt_student_id') || null;
                const studentEmail = `vtu${studentId}@veltech.edu.in`; // Synthetic email for logging

                await window.supabaseClient.rpc('log_student_login', {
                    p_email: studentEmail,
                    p_student_id: studentId
                });
            } catch (_) { }
        }

        function showDashboard() {
            hideAllSections();
            dashboardSection.classList.remove('hidden');
            try { initStudentMap(); } catch (_) { }
            try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch (_) { }
            try { setActiveTab(dashboardTab); location.hash = '#dashboard'; } catch (_) { }
        }

        /**
         * Populates the bus schedule table based on the selected date.
         */
        function formatTimeDisplay(hhmm) {
            try {
                if (!hhmm) return '';
                const [h, m] = hhmm.split(':');
                let hour = parseInt(h, 10);
                let minute = parseInt(m, 10);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12;
                if (hour === 0) hour = 12;
                return `${hour.toString().padStart(1, '0')}:${(minute || '00').toString().padStart(2, '0')} ${ampm}`;
            } catch { return hhmm; }
        }

        function showStops(busNo) {
            try {
                const mockRoutes = busScheduleData.filter(b => !b.isUserAdded);
                const allBusData = [...mockRoutes, ...adminAddedRoutes];

                const bus = allBusData.find(b => b && b.busNo === busNo) || null;

                if (!bus || !Array.isArray(bus.stops)) {
                    showMessage(`Stops not found for Bus ${busNo}.`);
                    return;
                }

                if (stopsModalTitle) stopsModalTitle.textContent = `Stops for Bus ${busNo}`;
                if (stopsTableBody) {
                    stopsTableBody.innerHTML = '';
                    bus.stops.forEach(s => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-200 hover:bg-gray-100 transition-colors duration-200';
                        const name = (s && (s.name || s.stop_name)) || '';
                        const t = (s && (s.time || s.estimated_arrival_time)) || '';
                        tr.innerHTML = `
                            <td class="py-3 px-6">${name}</td>
                            <td class="py-3 px-6">${formatTimeDisplay(String(t))}</td>
                        `;
                        stopsTableBody.appendChild(tr);
                    });
                }
                if (stopsModal) stopsModal.classList.remove('hidden');
            } catch (_) { }
        }

        function populateScheduleTable(selectedDate) {
            scheduleTableBody.innerHTML = '';
            const dayOfWeek = daysOfWeek[selectedDate.getDay()];

            const allBusData = [...adminAddedRoutes];

            if (allBusData.length === 0) {
                scheduleTableBody.innerHTML = `<tr><td colspan="4" class="py-3 px-6 text-center text-gray-400">No schedules available for this day.</td></tr>`;
                return;
            }

            allBusData.forEach(bus => {
                const schedule = bus.schedule[dayOfWeek];
                if (schedule) {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'transition-colors', 'duration-200', 'cursor-pointer');
                    row.setAttribute('data-bus-no', bus.busNo || '');
                    row.innerHTML = `
                            <td class="py-3 px-6">${bus.busNo}</td>
                            <td class="py-3 px-6">${bus.route}</td>
                            <td class="py-3 px-6">${formatTimeDisplay(schedule.departureTime)}</td>
                            <td class="py-3 px-6">${formatTimeDisplay(schedule.eta)}</td>
                        `;
                    scheduleTableBody.appendChild(row);
                }
            });
        }

        /**
         * Updates the current time displayed on the page.
         */
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            currentTimeEl.textContent = now.toLocaleDateString('en-IN', options);
        }

        // --- Dashboard KPIs (Student) ---
        const activeBusesCountEl = document.getElementById('active-buses-count');
        const onTimeCountEl = document.getElementById('on-time-count');

        // Helper: parse schedule time string (supports 'HH:MM' 24h) into a Date today
        function parseScheduleTimeToDate(timeStr) {
            try {
                if (!timeStr) return null;
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = now.getMonth();
                const dd = now.getDate();
                const [h, m] = timeStr.split(':');
                let hour = parseInt(h, 10) || 0;
                let minute = parseInt(m, 10) || 0;
                return new Date(yyyy, mm, dd, hour, minute, 0, 0);
            } catch (_) { return null; }
        }

        async function refreshStudentDashboardStats() {
            let active = 0;
            let onTime = 0;
            const mockRoutes = busScheduleData.filter(b => !b.isUserAdded);
            const allBusData = [...mockRoutes, ...adminAddedRoutes];

            // Fetch current positions (bus_no, updated_at)
            let positions = [];
            if (window.supabaseClient) {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('bus_positions')
                        .select('bus_no, updated_at');
                    if (!error && Array.isArray(data)) positions = data;
                } catch (_) { }
            }
            try { const s = new Set(); positions.forEach(r => r && r.bus_no && s.add(r.bus_no)); active = s.size; } catch (_) { }
            try { if (activeBusesCountEl) activeBusesCountEl.textContent = String(active); } catch (_) { }

            try {
                const dayOfWeek = daysOfWeek[new Date().getDay()];
                const byBusNo = new Map(); positions.forEach(p => { if (p && p.bus_no) byBusNo.set(p.bus_no, p); });
                const windowBeforeMs = 5 * 60 * 1000;
                const windowAfterMs = 10 * 60 * 1000;
                onTime = 0;
                allBusData.forEach(b => {
                    try {
                        if (!b || !b.busNo || !b.schedule || !b.schedule[dayOfWeek]) return;
                        const dep = parseScheduleTimeToDate(b.schedule[dayOfWeek].departureTime);
                        if (!dep) return;
                        const pos = byBusNo.get(b.busNo);
                        if (!pos || !pos.updated_at) return;
                        const upd = new Date(pos.updated_at);
                        const diff = upd.getTime() - dep.getTime();
                        if (diff >= -windowBeforeMs && diff <= windowAfterMs) onTime++;
                    } catch (_) { }
                });
            } catch (_) { onTime = 0; }
            try { if (onTimeCountEl) onTimeCountEl.textContent = String(onTime); } catch (_) { }
        }

        let _studentMapInitialized = false;
        let _studentBusMarkers = new Map();
        let _studentBusPollTimer = null;
        let _studentBusChannel = null;

        function initStudentMap() {
            try {
                const el = document.getElementById('college-map-student');
                if (!el || !window.L) return;
                if (!el.style.height || el.clientHeight === 0) { el.style.height = '100%'; }
                const LAT = 13.177470064893306;
                const LNG = 80.09811982470028;

                // If map already exists, just recenter and update marker/handlers
                if (window._studentLeafletMap) {
                    try {
                        window._studentLeafletMap.setView([LAT, LNG], 16);
                        if (window._studentMarker) { window._studentMarker.setLatLng([LAT, LNG]); }
                        window._studentLeafletMap.off('click');
                        window._studentLeafletMap.on('click', () => { try { window.open(`https://www.google.com/maps?q=${LAT},${LNG}`, '_blank'); } catch (_) { } });
                        setTimeout(() => { window._studentLeafletMap.invalidateSize(false); }, 0);
                    } catch (_) { }
                    return;
                }
                const map = L.map('college-map-student', { zoomControl: true, attributionControl: false }).setView([LAT, LNG], 16);
                window._studentLeafletMap = map;
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
                const pin = L.divIcon({
                    className: 'custom-pin-student',
                    html: '<svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#2563eb" stroke="white" stroke-width="2"/><circle cx="12" cy="9" r="3" fill="white"/></svg>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 36]
                });
                window._studentMarker = L.marker([LAT, LNG], { icon: pin })
                    .addTo(map)
                    .bindPopup('<b>Vel Tech University</b><br>400 Feet Outer Ring Rd, Avadi, Tamil Nadu 600055');
                map.on('click', () => { try { window.open(`https://www.google.com/maps?q=${LAT},${LNG}`, '_blank'); } catch (_) { } });
                window._studentMarker.on('click', (e) => { try { e.originalEvent?.stopPropagation?.(); } catch (_) { } });
                _studentMapInitialized = true;
                setTimeout(() => { map.invalidateSize(false); }, 300);
                try { if (window.supabaseClient) { initLiveBusesStudent(); } } catch (_) { }
            } catch (e) { }
        }

        /**
         * Displays a custom message box.
         * @param {string} message The message to display.
         */
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        /**
         * Hides the stops modal.
         */
        function hideStopsModal() {
            if (stopsModal) {
                stopsModal.classList.add('hidden');
            }
        }
        // Allow closing the stops modal by clicking the backdrop
        if (stopsModal) {
            stopsModal.addEventListener('click', (e) => {
                if (e.target === stopsModal) {
                    hideStopsModal();
                }
            });
        }
        // Allow closing the stops modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (stopsModal && !stopsModal.classList.contains('hidden')) {
                    hideStopsModal();
                }
                if (emergencyModal && !emergencyModal.classList.contains('hidden')) {
                    hideEmergencyModal();
                }
            }
        });

        /**
         * Initializes the admin notes display by fetching the latest note.
         */
        const ADMIN_NOTES_LAST_VIEWED_KEY = 'vt_admin_notes_last_viewed_at';

        function markNotesViewed(timestamp) {
            try { localStorage.setItem(ADMIN_NOTES_LAST_VIEWED_KEY, timestamp || ''); } catch (_) { }
            if (adminNotesBadge) adminNotesBadge.classList.add('hidden');
            if (dashboardNotesDot) dashboardNotesDot.classList.add('hidden');
            if (adminNotesDisplay) adminNotesDisplay.classList.remove('notes-blink');
        }

        function handleNotesUpdate(updatedAtIso) {
            const lastViewed = (() => {
                try { return localStorage.getItem(ADMIN_NOTES_LAST_VIEWED_KEY) || ''; } catch (_) { return ''; }
            })();
            const hasViewed = lastViewed && updatedAtIso && new Date(lastViewed).getTime() >= new Date(updatedAtIso).getTime();
            if (!hasViewed) {
                if (adminNotesBadge) adminNotesBadge.classList.remove('hidden');
                if (dashboardNotesDot) dashboardNotesDot.classList.remove('hidden');
                if (adminNotesDisplay) adminNotesDisplay.classList.add('notes-blink');
            }
        }

        if (adminNotesCard) {
            adminNotesCard.addEventListener('click', () => {
                if (adminNotesDisplay) {
                    adminNotesDisplay.classList.remove('notes-blink');
                }
                if (adminNotesBadge && !adminNotesBadge.classList.contains('hidden')) {
                    markNotesViewed(new Date().toISOString());
                }
            });
        }

        async function initializeAdminNotes() {
            adminNotesDisplay.textContent = 'Loading notes...';
            if (window.supabaseClient) {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('admin_notes')
                        .select('content, updated_at')
                        .order('updated_at', { ascending: false })
                        .limit(1);
                    if (!error && Array.isArray(data) && data.length > 0) {
                        adminNotesDisplay.textContent = data[0].content || '';
                        handleNotesUpdate(data[0].updated_at || new Date().toISOString());
                    } else if (data && data.length === 0) {
                        adminNotesDisplay.textContent = 'No special notes from Admin at this time.';
                        markNotesViewed(new Date().toISOString());
                    }
                } catch (e) {
                    console.error('initializeAdminNotes error', e);
                    adminNotesDisplay.textContent = 'Failed to load notes.';
                }
            }
        }

        // Realtime subscription for admin notes
        let _notesChannel = null;
        function subscribeAdminNotes() {
            try {
                if (!window.supabaseClient || _notesChannel) return;
                _notesChannel = window.supabaseClient
                    .channel('admin_notes_live_student')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'admin_notes' }, (payload) => {
                        try {
                            const row = payload.new || payload.old || null;
                            if (payload.eventType === 'DELETE') {
                                initializeAdminNotes();
                                return;
                            }
                            if (row && row.content && adminNotesDisplay) {
                                adminNotesDisplay.textContent = row.content;
                                handleNotesUpdate(row.updated_at || new Date().toISOString());
                            } else {
                                initializeAdminNotes();
                            }
                        } catch (_) { }
                    })
                    .subscribe();
            } catch (_) { }
        }

        /**
         * Shows the emergency modal.
         */
        function showEmergencyModal() {
            if (emergencyModal) {
                emergencyModal.classList.remove('hidden');
                loadEmergencyContacts();
            }
        }

        /**
         * Hides the emergency modal.
         */
        function hideEmergencyModal() {
            if (emergencyModal) {
                emergencyModal.classList.add('hidden');
            }
        }

        /**
         * Loads emergency contacts from database.
         */
        async function loadEmergencyContacts() {
            if (!window.supabaseClient || !emergencyContacts) return;

            try {
                const { data, error } = await window.supabaseClient
                    .from('emergency_contacts')
                    .select('*')
                    .eq('is_active', true)
                    .not('contact_type', 'in', '(transport_office,admin)') // Filter out transport office and admin
                    .order('priority', { ascending: true });

                if (!error && Array.isArray(data)) {
                    // Clear existing contacts to prevent duplicates
                    emergencyContacts.innerHTML = '';

                    // Use a Set to ensure no duplicates by phone number
                    const seenPhones = new Set();
                    const uniqueContacts = data.filter(contact => {
                        if (!seenPhones.has(contact.phone)) {
                            seenPhones.add(contact.phone);
                            return true;
                        }
                        return false;
                    });

                    uniqueContacts.forEach(contact => {
                        const contactDiv = document.createElement('div');
                        contactDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                        contactDiv.innerHTML = `
                            <div>
                                <div class="font-medium text-gray-800">${contact.name}</div>
                                <div class="text-sm text-gray-600">${contact.phone}</div>
                                ${contact.email ? `<div class="text-xs text-gray-500">${contact.email}</div>` : ''}
                            </div>
                            <button onclick="window.open('tel:${contact.phone}', '_self')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                ðŸ“ž Call
                            </button>
                        `;
                        emergencyContacts.appendChild(contactDiv);
                    });
                }
            } catch (e) {
                console.error('Error loading emergency contacts:', e);
            }
        }

        /**
         * Handles panic button click.
         */
        async function handlePanicButton() {
            const studentId = localStorage.getItem('vt_student_id') || 'unknown';
            const currentLocation = await getCurrentLocation();

            try {
                const result = await window.createEmergencyIncident(
                    'panic_button',
                    'student',
                    studentId,
                    null, // bus_no
                    null, // route_id
                    currentLocation ? currentLocation.lat : null,
                    currentLocation ? currentLocation.lng : null,
                    'Panic button activated by student',
                    'critical'
                );

                if (result.error) {
                    showMessage('Failed to send emergency alert. Please try again or call emergency services directly.');
                } else {
                    showMessage('ðŸš¨ Emergency alert sent successfully! Help is on the way. Please stay safe.');
                    hideEmergencyModal();
                }
            } catch (error) {
                console.error('Panic button error:', error);
                showMessage('Emergency alert failed. Please call emergency services directly.');
            }
        }

        /**
         * Gets current location using browser geolocation.
         */
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    resolve(null);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        console.log('Geolocation error:', error);
                        resolve(null); // Don't reject, just return null
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    }
                );
            });
        }

        /**
         * Initializes emergency features.
         */
        async function initEmergencyFeatures() {
            // Load emergency contacts on startup
            await loadEmergencyContacts();

            // Set up emergency modal backdrop click
            if (emergencyModal) {
                emergencyModal.addEventListener('click', (e) => {
                    if (e.target === emergencyModal) {
                        hideEmergencyModal();
                    }
                });
            }

            // Note: Escape key handler is now consolidated in the main escape key handler above
        }

        /**
         * Loads routes from the database and structures them for local use.
         */
        async function loadAdminRoutes() {
            adminAddedRoutes = [];
            if (!window.supabaseClient) return;
            try {
                const { data, error } = await window.supabaseClient
                    .from('bus_routes')
                    .select('route_number, route_name, route_stops(sequence_order, estimated_arrival_time, bus_stops(stop_name))');
                if (!error && Array.isArray(data)) {
                    adminAddedRoutes = data.map(r => {
                        const stopsArr = (r.route_stops || []).sort((a, b) => a.sequence_order - b.sequence_order);

                        const stops = stopsArr.map(s => ({
                            name: (s.bus_stops && s.bus_stops.stop_name) || '',
                            time: (s.estimated_arrival_time || '').toString().slice(0, 5) // 24h HH:MM
                        }));

                        const dep = stopsArr.length ? stops[0].time : ''; // Departure is first stop time
                        const arr = stopsArr.length ? stops[stopsArr.length - 1].time : ''; // ETA is last stop time

                        const sched = {};
                        // Schedule for all days is the same (based on the stops data)
                        daysOfWeek.forEach(d => {
                            sched[d] = {
                                departureTime: dep,
                                eta: arr
                            };
                        });
                        return { busNo: r.route_number, route: r.route_name, schedule: sched, stops, isUserAdded: true };
                    });
                } else if (error) {
                    console.error("Error loading admin routes:", error);
                }
            } catch (e) { console.error('loadAdminRoutes DB error', e); }
        }

        /**
         * Generates and displays the clickable weekly date buttons.
         */
        function generateWeeklyDates() {
            weeklyDatesContainer.innerHTML = '';
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday...

            // Start from Monday of the current week
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

            // Generate buttons for Monday to Saturday
            for (let i = 0; i < 6; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);

                const dayName = daysOfWeek[date.getDay()].substring(0, 3);
                const dateNum = date.getDate();
                const month = date.toLocaleString('default', { month: 'short' });
                const fullDate = date.toISOString().split('T')[0];

                const button = document.createElement('button');
                button.classList.add('px-3', 'py-2', 'font-medium', 'text-gray-600', 'rounded-lg', 'hover:bg-gray-200', 'focus:outline-none', 'focus:bg-gray-200', 'transition-colors', 'duration-200', 'flex', 'flex-col', 'items-center', 'border', 'border-gray-300');
                if (fullDate === today.toISOString().split('T')[0]) {
                    button.classList.add('bg-gray-200');
                }
                button.dataset.date = fullDate;
                button.innerHTML = `
                    <span class="text-xs">${dayName}</span>
                    <span class="text-sm font-bold">${dateNum}</span>
                    <span class="text-xs">${month}</span>
                `;
                weeklyDatesContainer.appendChild(button);
            }

            // Add event listeners to the newly created buttons
            weeklyDatesContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Remove active state from all buttons
                    weeklyDatesContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-gray-200'));
                    // Add active state to the clicked button
                    e.currentTarget.classList.add('bg-gray-200');
                    const selectedDate = new Date(e.currentTarget.dataset.date);
                    populateScheduleTable(selectedDate);
                });
            });
        }


        function setActiveTab(activeBtn) {
            const tabs = [dashboardTab, scheduleTab];
            tabs.forEach(btn => {
                if (!btn) return;
                const isActive = btn === activeBtn;
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                btn.classList.toggle('bg-gray-200', isActive);
                btn.classList.toggle('text-gray-800', isActive);
                btn.classList.toggle('text-gray-600', !isActive);
            });
        }

        // --- Event Listeners ---
        if (dashboardTab) { dashboardTab.addEventListener('click', showDashboard); }
        if (logo) { logo.addEventListener('click', showDashboard); }
        if (siteTitle) { siteTitle.addEventListener('click', showDashboard); }

        scheduleTab.addEventListener('click', async () => {
            hideAllSections();
            scheduleSection.classList.remove('hidden');

            // Reload routes and then display
            await loadAdminRoutes();
            generateWeeklyDates();
            populateScheduleTable(new Date());

            try { setActiveTab(scheduleTab); location.hash = '#schedule'; } catch (_) { }
        });



        messageOkBtn.addEventListener('click', hideMessage);

        // --- Optional Live Bus Markers (Student) ---
        function initLiveBusesStudent() {
            try {
                if (!window.supabaseClient || !window._studentLeafletMap) return;
                if (!_studentBusMarkers) _studentBusMarkers = new Map();

                // initial load
                loadCurrentBusPositionsStudent();

                // polling every 10s (works without Realtime but Realtime is better)
                if (!_studentBusPollTimer) {
                    _studentBusPollTimer = setInterval(loadCurrentBusPositionsStudent, 10000);
                }
                subscribeBusPositionsStudent();
            } catch (e) { }
        }

        async function loadCurrentBusPositionsStudent() {
            try {
                if (!window.supabaseClient) return;

                // Get bus positions
                const { data: positions, error: posError } = await window.supabaseClient
                    .from('bus_positions')
                    .select('bus_no, lat, lng');

                if (posError || !Array.isArray(positions)) return;

                // Get active route assignments
                const { data: assignments, error: assignError } = await window.supabaseClient
                    .from('active_route_assignments')
                    .select('driver_id, route_number, route_name, status')
                    .eq('status', 'active');

                // Create a map of bus_no -> route info
                const routeMap = new Map();
                if (!assignError && Array.isArray(assignments)) {
                    assignments.forEach(a => {
                        if (a.driver_id && a.route_number) {
                            routeMap.set(a.driver_id, {
                                routeNumber: a.route_number,
                                routeName: a.route_name || ''
                            });
                        }
                    });
                }

                const seen = new Set();
                positions.forEach(r => {
                    if (r && r.bus_no != null && r.lat != null && r.lng != null) {
                        seen.add(r.bus_no);
                        const routeInfo = routeMap.get(r.bus_no);
                        upsertBusMarkerStudent(r.bus_no, r.lat, r.lng, routeInfo);
                    }
                });

                if (_studentBusMarkers) {
                    Array.from(_studentBusMarkers.keys()).forEach(key => {
                        if (!seen.has(key)) {
                            removeBusMarkerStudent(key);
                        }
                    });
                }
            } catch (e) { }
        }

        function upsertBusMarkerStudent(busNo, lat, lng, routeInfo) {
            try {
                if (!_studentBusMarkers) _studentBusMarkers = new Map();
                const pos = [lat, lng];

                // Determine display label: use route if available, otherwise bus number
                const displayLabel = routeInfo
                    ? `${routeInfo.routeNumber}${routeInfo.routeName ? ' - ' + routeInfo.routeName : ''}`
                    : `Bus ${busNo}`;

                if (_studentBusMarkers.has(busNo)) {
                    const marker = _studentBusMarkers.get(busNo);
                    marker.setLatLng(pos);
                    marker.setTooltipContent(displayLabel);
                } else {
                    // Custom bus icon placeholder (simple blue marker)
                    const busIcon = L.divIcon({
                        className: 'custom-bus-icon',
                        html: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h-2l-2-2h-4L8 4H6C5 4 4 5 4 6v10c0 1 1 2 2 2h10c1 0 2-1 2-2V6c0-1-1-2-2-2zm-6 14H8v-2h2v2zm4 0h-2v-2h2v2zm-6-4H6V6h12v8h-2V8h-8v6z" fill="#EF4444"/><circle cx="8" cy="18" r="1.5" fill="#EF4444"/><circle cx="14" cy="18" r="1.5" fill="#EF4444"/></svg>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });

                    const mk = L.marker(pos, { icon: busIcon, title: displayLabel })
                        .addTo(window._studentLeafletMap)
                        .bindTooltip(displayLabel);
                    _studentBusMarkers.set(busNo, mk);
                }
            } catch (e) { }
        }

        function removeBusMarkerStudent(busNo) {
            try {
                if (_studentBusMarkers && _studentBusMarkers.has(busNo)) {
                    const mk = _studentBusMarkers.get(busNo);
                    try { window._studentLeafletMap.removeLayer(mk); } catch (_) { }
                    _studentBusMarkers.delete(busNo);
                }
            } catch (e) { }
        }

        function subscribeBusPositionsStudent() {
            try {
                if (!window.supabaseClient || _studentBusPosChannel) return;
                _studentBusPosChannel = window.supabaseClient
                    .channel('bus_positions_live_student')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'bus_positions' }, (payload) => {
                        try {
                            // Reload all positions to get updated route assignments
                            loadCurrentBusPositionsStudent();
                        } catch (_) { }
                    })
                    .subscribe();
            } catch (_) { }
        }

        // Refresh student KPIs on dashboard show and periodically (visibility-aware) + hash routing
        async function initializeStudentInterface() {
            try {
                // Initialize KPI timer
                refreshStudentDashboardStats();
                if (window._studentKpiTimer) { clearInterval(window._studentKpiTimer); }
                window._studentKpiTimer = setInterval(refreshStudentDashboardStats, 15000);

                // Set up visibility change handler
                document.addEventListener('visibilitychange', () => {
                    try {
                        if (document.hidden) {
                            if (window._studentKpiTimer) { clearInterval(window._studentKpiTimer); window._studentKpiTimer = null; }
                        } else {
                            refreshStudentDashboardStats();
                            if (!window._studentKpiTimer) { window._studentKpiTimer = setInterval(refreshStudentDashboardStats, 15000); }
                        }
                    } catch (_) { }
                });

                // Hash routing: #dashboard, #schedule
                if (location.hash) {
                    const h = location.hash;
                    if (h === '#dashboard') {
                        showDashboard();
                    } else if (h === '#schedule') {
                        // Click the tab to trigger its logic
                        scheduleTab.click();
                    }
                } else {
                    // Default view
                    showDashboard();
                }
            } catch (_) { }
        }


        scheduleTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row) {
                const busNo = row.getAttribute('data-bus-no');
                showStops(busNo);
            }
        });

        closeStopsModal.addEventListener('click', hideStopsModal);

        // Emergency event listeners
        if (emergencyBtn) { emergencyBtn.addEventListener('click', showEmergencyModal); }
        if (closeEmergencyModal) { closeEmergencyModal.addEventListener('click', hideEmergencyModal); }
        if (panicButton) { panicButton.addEventListener('click', handlePanicButton); }

        // --- Notification Logic ---
        const notificationBtn = document.getElementById('notification-btn');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationBadge = document.getElementById('notification-badge');
        const notificationList = document.getElementById('notification-list');
        const markAllReadBtn = document.getElementById('mark-all-read');
        let notifications = [];

        function initNotifications() {
            if (!notificationBtn || !notificationDropdown) return;

            // Toggle dropdown
            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationDropdown.classList.toggle('hidden');
                if (!notificationDropdown.classList.contains('hidden')) {
                    markNotificationsAsViewed();
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                    notificationDropdown.classList.add('hidden');
                }
            });

            // Mark all as read
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllNotificationsRead);
            }

            // Initial fetch and subscribe
            fetchNotifications();
            subscribeToNotifications();
        }

        async function fetchNotifications() {
            if (!window.supabaseClient) return;

            try {
                // Fetch notifications for 'all' or 'students' within last 24 hours
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                const { data, error } = await window.supabaseClient
                    .from('notifications')
                    .select('*')
                    .or('recipient_type.eq.all,recipient_type.eq.students')
                    .gte('created_at', oneDayAgo)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (!error && data) {
                    notifications = data;
                    updateNotificationUI();
                }
            } catch (e) {
                console.error('Error fetching notifications:', e);
            }
        }

        function subscribeToNotifications() {
            if (!window.supabaseClient) return;

            window.supabaseClient
                .channel('public:notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
                    const newNotif = payload.new;
                    if (newNotif && (newNotif.recipient_type === 'all' || newNotif.recipient_type === 'students')) {
                        notifications.unshift(newNotif);
                        updateNotificationUI();
                        // Optional: Show a toast/alert for new high-priority notifications
                        if (newNotif.notification_type === 'emergency' || newNotif.notification_type === 'warning') {
                            showMessage(`ðŸ”” New Alert: ${newNotif.title}`);
                        }
                    }
                })
                .subscribe();
        }

        function updateNotificationUI() {
            if (!notificationList || !notificationBadge) return;

            // Update Badge (count unread locally for simplicity, or implementation specifics)
            // For this simple version, we'll check local storage to see which IDs are read
            const readIds = JSON.parse(localStorage.getItem('vt_read_notifications') || '[]');
            const unreadCount = notifications.filter(n => !readIds.includes(n.id)).length;

            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }

            // Render List
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 text-center">No new notifications</div>';
            } else {
                notificationList.innerHTML = notifications.map(n => {
                    const isRead = readIds.includes(n.id);
                    const bgClass = isRead ? 'bg-white' : 'bg-blue-50';
                    const icon = getNotificationIcon(n.notification_type);
                    return `
                        <div class="px-4 py-3 border-b border-gray-100 ${bgClass} hover:bg-gray-50 transition-colors duration-150">
                            <div class="flex items-start">
                                <span class="flex-shrink-0 pt-0.5">${icon}</span>
                                <div class="ml-3 w-full">
                                    <p class="text-sm font-medium text-gray-900">${n.title}</p>
                                    <p class="text-xs text-gray-500 mt-0.5">${n.message}</p>
                                    <p class="text-xs text-gray-400 mt-1">
                                        ${new Date(n.created_at).toLocaleString()}
                                        ${n.specific_bus ? `<br><span class="text-blue-500">Bus: ${n.specific_bus}</span>` : ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'emergency': return 'ðŸš¨';
                case 'warning': return 'âš ï¸';
                case 'success': return 'âœ…';
                case 'info': default: return 'â„¹ï¸';
            }
        }

        function markNotificationsAsViewed() {
            // When dropdown opens, we could mark them as "viewed" but maybe not "read" yet
            // For now, let's keep "read" as explicit or when clicking "mark all read"
            // Or we can auto-mark all displayed as read?
            // User requirement was just "recieve msg", so let's keep it simple.
        }

        function markAllNotificationsRead() {
            const allIds = notifications.map(n => n.id);
            localStorage.setItem('vt_read_notifications', JSON.stringify(allIds));
            updateNotificationUI();
        }

        function logoutStudent() {
            try {
                // Hide all modals
                hideStopsModal();
                hideEmergencyModal();
                hideMessage();

                // Clear all intervals and timers
                if (window._studentKpiTimer) {
                    clearInterval(window._studentKpiTimer);
                    window._studentKpiTimer = null;
                }
                if (_studentBusPollTimer) {
                    clearInterval(_studentBusPollTimer);
                    _studentBusPollTimer = null;
                }

                // Unsubscribe from realtime channels
                try {
                    if (_studentBusChannel) {
                        window.supabaseClient.removeChannel(_studentBusChannel);
                        _studentBusChannel = null;
                    }
                    if (_notesChannel) {
                        window.supabaseClient.removeChannel(_notesChannel);
                        _notesChannel = null;
                    }
                } catch (e) { }

                // Clear map and markers if they exist
                try {
                    if (window._studentLeafletMap) {
                        window._studentLeafletMap.remove();
                        window._studentLeafletMap = null;
                        window._studentMarker = null;
                    }
                    if (_studentBusMarkers) {
                        _studentBusMarkers.clear();
                        _studentBusMarkers = null;
                    }
                } catch (e) { }

                // Clear local storage
                localStorage.removeItem('vt_student_authed');
                localStorage.removeItem('vt_student_id');

                // Redirect to login
                window.location.href = 'student-login.html';
            } catch (e) {
                console.error('Logout error:', e);
                // Force redirect even if cleanup fails
                window.location.href = 'student-login.html';
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Student interface initializing...');

            try {
                hideStopsModal();
                hideEmergencyModal();

                // Load admin data (notes and routes)
                await initializeAdminNotes();
                subscribeAdminNotes();
                await loadAdminRoutes();

                // Initialize emergency features
                await initEmergencyFeatures();

                initStudentMap();

                // Start the clock
                updateTime();
                setInterval(updateTime, 1000);

                // Preload schedule for today
                populateScheduleTable(new Date());

                // Initialize student interface features
                await initializeStudentInterface();

                // Initialize notifications
                initNotifications();

                // Log student login (once per load)
                logStudentLogin();

            } catch (error) {
                console.error('Error during student interface initialization:', error);
            }
        });

        studentLogoutBtn.addEventListener('click', logoutStudent);
    </script>
</body>

</html>